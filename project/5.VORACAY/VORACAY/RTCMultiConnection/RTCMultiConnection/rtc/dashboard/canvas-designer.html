<!-- Demo version: 2018.12.11 -->

<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, initial-scale=0.66, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <title>VORACAY</title>
  <meta name="description" content="WebRTC Dashboard including support for canvas drawing, canvas data syncing, video conferencing, screen sharing and video conferencing. Including chat and file sharing.">

  <!-- <link rel="shortcut icon" href="/demos/logo.png"> -->
  <link rel="stylesheet" type="text/css" href="/rtc/css/emojionearea.min.css">
  <link rel="icon" href="./voracay.ico">

  <!-- <script src="/rtc/js/jquery.min.js"></script> -->
  <script src="/rtc/js/jquery-3.5.1.min.js"></script>
  <script src="/rtc/js/bootstrap.min.js"></script>

  <link href="/rtc/css/bootstrap.min.css" rel="stylesheet">
  <script src="/node_modules/webrtc-adapter/out/adapter.js"></script>
  <script src="/dist/RTCMultiConnection.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/node_modules/fbr/FileBufferReader.js"></script>


 
  <!-- <script src="/node_modules/canvas-designer/dev/webrtc-handler.js"></script>
  <script src="/node_modules/canvas-designer/canvas-designer-widget.js"></script> -->
   <!--수정한 js코드 dist폴더로 뺌-->
  <script src="/dist/canvas-designer/dev/webrtc-handler.js"></script>
  <script src="/dist/canvas-designer/canvas-designer-widget.js"></script>
  <script src="/rtc/js/emojionearea.min.js"></script>
  <!-- <script src="/node_modules/multistreamsmixer/MultiStreamsMixer.js"></script> -->
  <!--Record streams audio 모듈 추가-->
  <script src="/node_modules/recordrtc/RecordRTC.js"></script>
  <script src="/dist/sweetalert/dist/sweetalert.min.js"></script>
<style type="text/css">
/* html, body, section, ul, li, nav, a, h1, h2 {
    padding: 0;
    margin: 0;
    outline: none;
    text-shadow: none;
    box-shadow: none;
    border-radius: 0;
    text-decoration: none;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    font-size: 17px;
    line-height: 1.5em;
}

input[disabled], button[disabled] {
    background: transparent!important;
    color: #dcd7d7!important;
    border: 1px solid #dcd7d7!important;
    cursor: not-allowed!important;
    text-shadow: none!important;
    box-shadow: none!important;
    text-decoration: none!important;
    outline: none!important;
} */

</style>
</head>
<body>


<div class="voracay">
    <video id="main-video"  playsinline autoplay></video>
    <img id="main-img"/>
    <div class="meetingroom">
      <div id="sidebar" class="sidebar">
        <!-- loadImage('./img/NAMU.png') -->
        <div class="btn-zip">
          <input type="radio" id="participant-btn" name="button"checked="checked" />
          <label for="participant-btn" id="participant-label" class="btn-item participant-btn"
            >참가자  <img  src="../img/participant.png" alt="참가자" width="25" height="25" /></label
          >

          <input type="radio" id="chat-btn" name="button"  />
          <label for="chat-btn" id="chat-label" class="btn-item chat-btn"
            >채팅  <img  src="../img/chat.png" alt="채팅" width="30" height="30" /></label
          >

          <input type="radio" id="save-btn" name="button" />
          <label for="save-btn" id="save-label" class="btn-item save-btn"
            >보관함  <img  src="../img/list1.png" alt="보관함" width="25" height="25" /></label
          >

        </div>
        <div class="chosed-box">
          <img src="../img/back.png" class="back" onclick="mobileClickBack()"></button>
          <div class="mobile-title"></div>
          <div id="participant-boxid" >
                <div id="participantboxact" class="participant-box ">
                  <div id="onUserStatusChanged">
                      <div id='participant-list'></div>
                  </div> 
                </div>
          </div>
          <div id="chat-boxid" class="active">
            <div id="chatboxact" class="chat-box active">
                <div id="chat-send" >
                    <textarea id="txt-chat-message"></textarea>
                    <!-- <div id="chat-btn"> -->
                        <!-- <button class="btn btn-primary" id="btn-chat-message" disabled> class="btn btn-primary" -->
                            <img  id="btn-chat-message" src="../img/send.png"title="전송" alt="전송" width="30" height="30" disabled />
                        <!-- </button> -->
                        <img id="btn-attach-file" src="../img/clip.png"title="파일첨부" alt="파일첨부" width="30" height="30" />
                     <!-- </div> -->
                </div>
                <div id="chat-container">
                    <div id="conversation-panel"></div>
                </div>
            </div>
           
          </div><!--chat-boxid -->
          <!-- 보관함 -->
          <div id="save-boxid"class="active">
            <div id="saveboxact" class="save-box active">
                <div id="uploaded-container-header">
                    <div id="savebox-header">
                        기록 영상명 </div>
                    <div id="savebox-header-day">
                            기록일 </div>
                </div>
                <div id="uploaded-container">
                    <div id="uploaded-list"></div>
                </div>
            </div>
          </div>
        </div>
      </div> 

      <!-- containerA -->
     
      <div id="containerA" >
        <input type="checkbox" id="select-mobile-cam">
        <div class="containerB">
            <div class="logo">
                <a class="logo-a" href="https://k3d106.p.ssafy.io/main"><img src="../img/NAMU.png" alt="voda 로고" width="50" height="50" />VORACAY</a>
                <div id="select-mobile">
                    <label for="select-mobile-cam" >
                        <i>
                            <img id="btn-mobile-cam" src="../img/cam-switch.png" alt="CAM" width="70" height="50" />
                        </i> 
                    </label>
                </div>
            </div>
            <div class="select-mobile-cam-menu">
                <div class="hiddenbar">
                    <div class="select" id="mobile-device-box">
                        <label id="mobile-device-box-label"for="videoSource">Video Select</label>
                        <select id="videoSource"></select>
                        <input type="hidden" name="select_flag" id="select_flag" value="0">
                    </div>
                </div>
            </div>
        </div>
        <!-- <div id="logo">
            <img  id="btn-chat-message" src="../img/send.png"title="전송" alt="전송" width="30" height="30" disabled />
        </div> -->
        <div id="captiondiv" class="captionBox">
        </div>
        <div class="paging-button">
            <div id="paging-prev"></div>
        </div>
            <div id="other-videos" ></div>
        <div class="paging-button">
            <div id="paging-next"></div>
        </div>
            <div id="isMemo">
                <div id="widget-container" >
                    <audio id="main-audio" controls playsinline autoplay></audio>
                </div>
                
            </div> 
      </div>
    </div>
    <input type="checkbox" id="menuicon">
    <div class="plus-box"></div>
    <div class="meeting-bottom">
      <div class="bottom-btn-box">
        <!-- <div id="camera-selector" class="btn btn-dark">
            <i class="active">
                <img class="oncam" src="../img/cam2.png" alt="전면" width="40" height="40" />
                <img class="offcam" src="../img/cam1.png" alt="후면" width="40" height="40" />
            </i>
            <p class="arrow_box">카메라 선택</p>
        </div> -->
        <div id="onoff-cam" class="onoff-cam circle-btn">
          <i class="active">
              <img class="oncam" src="../img/cam2.png" alt="캠" width="40" height="40" />
              <img class="offcam" src="../img/cam1.png" alt="캠" width="40" height="40" /></i>
          <p class="arrow_box">카메라</p>
        </div>

        <div id="onoff-mic" class="onoff-mic circle-btn">
          <i class="active">
            <img class="onmic" src="../img/micon.png" alt="마이크" width="40" height="40" />
            <img class="offmic" src="../img/micoff.png" alt="마이크" width="40" height="40" /></i>

          </i>
          <p class="arrow_box">마이크</p>
        </div>

        <div id="invitelink" class="circle-btn invitelink">
            <i>
              <img src="../img/invite.png" alt="초대" width="40" height="40" />
            </i>
            <p class="arrow_box">초대 링크</p>
        </div>
        <div id="share-screen" class="circle-btn">
            <i>
                <img id="btn-share-my-camera" src="../img/Screensharing.png" alt="Screensharing" width="50" height="40" />
            </i>
            <p class="arrow_box">Screen Sharing</p>
        </div>
        <div id="share-board" class="circle-btn">
            <i>
                <img id="btn-white-board" src="../img/boardshare.png" alt="boardsharing" width="50" height="60" />
            </i>
            <p class="arrow_box">Board Sharing</p>
        </div>
        <!-- <div id="onoff-list1" class="circle-btn">
            <button class="btn btn-primary"id="btn-white-board">WhiteBoard</button>
        </div> -->
        
        <div id="record" class="circle-btn">
            <i>
                <img id="btn-record-message" src="../img/recoff.png" alt="Record" width="40" height="40" />
            </i>
            <p class="arrow_box">Record</p>
            
        </div>

        <div id="conference" class="circle-btn">
            <i class="active">
                <img id="btn-memo-message" src="../img/conference.png" alt="공유정지" width="40" height="35" />
            </i>
            <p class="arrow_box">회의화면</p>
            
        </div>
        <div id="clear" class="circle-btn">
            <i>
                <img id="btn-clear-message" src="../img/clean.png" alt="전체삭제" width="50" height="70" />
            </i>
            <p class="arrow_box">clear</p>
            
        </div>

        
        <div id="more" class="circle-btn">
            <label for="menuicon" class="menubtn">
                <i >
                    <img id="btn-more" src="../img/more.png" alt="더 보기" width="70" height="50" />
                    <img id="btn-more-click" src="../img/more1.png" alt="더 보기" width="70" height="50" />
                </i> 
            </label>
        </div>

        <div id="close" class="circle-btn">
            <i >
                <img id="btn-close" src="../img/close.png" alt="종료" width="40" height="40" />
            </i>  
        </div>

        <!-- <div id="onoff-reg" class="circle-btn">
            <button class="btn btn-primary" id="btn-clear-message">clear</button>
        </div> -->
      </div>
    </div>
    <div class="plus-menu">
        <div class="sidebar-menu">
           <div class="sidebar-first">
                <div id="share-screen-m" class="circle-btn btn-m">
                    <i class="sidebar-i">
                        <img id="btn-share-my-camera-m" src="../img/Screensharing.png" alt="Screensharing" width="50" height="40" />
                    </i>
                    <p class="btn-label">Screen<br> Sharing</p>
                </div>

                <div id="share-board-m" class="circle-btn btn-m">
                    <i class="sidebar-i">
                        <img id="btn-white-board-m" src="../img/boardshare.png" alt="boardsharing" width="50" height="60" />
                    </i>
                    <p class="btn-label">Board <br> Sharing</p>
                </div>

                <div id="clear-m" class="circle-btn  btn-m">
                    <i class="sidebar-i">
                        <img id="btn-clear-message-m" src="../img/clean.png" alt="전체삭제" width="50" height="70" />
                    </i>
                    <p class="btn-label">Board <br> Clear</p>
                    
                </div>
           </div>
           <div class="sidebar-second">
                <div id="record-m" class="circle-btn btn-m">
                    <i class="sidebar-i">
                        <img id="btn-record-message-m" src="../img/recoff.png" alt="Record" width="40" height="40" />
                    </i>
                    <p class="btn-label">Record</p>
                </div>
                <div id="invitelink-m" class="circle-btn btn-m invitelink">
                    <i class="sidebar-i">
                    <img src="../img/invite.png" alt="초대" width="40" height="40" />
                    </i>
                    <p class="btn-label">초대 링크</p>
                </div>
                <div id="conference-m" class="circle-btn btn-m">
                    <i class="sidebar-i active">
                        <img id="btn-memo-message-m" src="../img/conference.png" alt="공유정지" width="40" height="35" />
                    </i>
                    <p class="btn-label">회의화면</p>
                    
                </div>
           </div>
           <div class="sidebar-third">
                <div id="participant-m" onclick="moblieClickParticipant('participant-boxid')" class="circle-btn btn-m">
                    <i class="sidebar-i">
                        <img id="btn-participant-m" src="../img/participant-btn.png" alt="participant" width="40" height="40" />
                    </i>
                    <p class="btn-label">참가자</p>
                </div>
                <div id="chat-m" class="circle-btn btn-m" onclick="moblieClickParticipant('chat-boxid')">
                    <i class="sidebar-i">
                    <img id="btn-chat-m"src="../img/chat-btn.png" alt="채팅" width="40" height="40" />
                    </i>
                    <p class="btn-label">채팅</p>
                </div>
                <div id="savebox-m" class="circle-btn btn-m" onclick="moblieClickParticipant('save-boxid')">
                    <i class="sidebar-i ">
                        <img id="btn-savebox-m" src="../img/list1-btn.png" alt="보관함" width="40" height="35" />
                    </i>
                    <p class="btn-label">보관함</p>
                    
                </div>
           </div>
           
        </div>
    </div>
  </div>
  
        <!-- <button class="btn btn-primary" id="btn-searchall-my-record-media">getRecordList</button> -->
        <!-- <button class="btn btn-primary" id="btn-search-my-record-media">getRecordDetail</button> -->

    
    <div class="modal fade" id="mediaFormToSave" tabindex="-1" role="dialog" aria-labelledby="mediaFormToSaveLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="mediaFormToSaveLabel">녹화 영상 저장</h5>
              <button type="button" class="close modal-close-btn" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div>
                <div class="form-group">
                  <p>
                    <label for="txt-media-title" class="col-form-label">영상 제목:</label>
                    <input type="text" class="form-control" id="txt-media-title">
                  </p>
                </div>
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn modal-close-btn">취소</button>
              <button type="button" class="btn btn-primary" id="btn-save-record-media-modal">저장</button>
            </div>
          </div>
        </div>
      </div>
      <canvas id="temp-stream-canvas" style="display: none; touch-action: manipulation;"></canvas>
</div>



<script>
const recognition = new webkitSpeechRecognition();//마이크
navigator.mediaDevices.enumerateDevices().then(gotDevices).catch(handleError);
function getURLParameter(name) {
	return decodeURI((RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]);
}
function hideURLParams() {
	//Parameters to hide (ie ?success=value, ?error=value, etc)
	var hide = ['success','error'];
	for(var h in hide) {
		if(getURLParameter(h)) {
			history.replaceState(null, document.getElementsByTagName("title")[0].innerHTML, window.location.pathname);
		}
	}
}
function noEvent() { // 새로 고침 방지
    if (event.keyCode == 116) {
        swal("새로고침을 할 수 없습니다.");
        event.keyCode = 2;
        return false;
    } else if (event.ctrlKey
            && (event.keyCode == 78 || event.keyCode == 82)) {
        return false;
    }
}
document.onkeydown = noEvent;

window.onload = hideURLParams;
let init_btn_sync = false; // 방버튼정보를 최초 동기화 하였는가??
let init_share_media = false; // share정보 최초 동기화 하였는가??

let btn_memo_flag = false; // 회의화면 or canvas화면 btn

let btn_record_flag = false; // record 시작/ 끝

let streamArr = []; // 모든 참여자 음성 stream arr
let recordAudioFormData; // 저장된 audioData
let recordVideoFormData; // 저장된 videoData

let recordAudioFormData2; // 저장된 audioData
let recordVideoFormData2; // 저장된 videoData



let tempVideoSrc = ""; // 보내기전 데이터
let tempAudioSrc = ""; // 
let tempImageSrc = "";

let recorder; // RTC recorder

let isMediaSharing = false; // 미디어 공유중인지?
let isShareMyMedia = false; // 자기 미디어 공유중인지? - 제어권 가짐 -> 아직 개발단계

let finishShareMidia = false; // 공유가 끝났는지?
// test 용 -> 나중에는 canvas 영상 재생할때만 canvas하단에 배치할것
var audio = document.getElementById('main-audio');
var video = document.getElementById('main-video');
var image = document.getElementById("main-img");
//audio.style.display = '';
audio.addEventListener('play', audioHandler, false);
audio.addEventListener('pause', audioHandler, false);
audio.addEventListener('seeked', audioHandler, false);
clearMedia();
$('#btn-save-recorded-data').click(function(e) {
    //e.preventDefault();
    $('#mediaFormToSave').modal('show');
  });

// audio 제어 핸들러
function audioHandler(e) {
    if (e.type == 'play') {
      // play your audio
        console.log("audio play ")
        video.play()
        syncMediaControls('play',-1)

    } else if (e.type == 'pause') {
      // pause your audio
        console.log("audio pause ")
        video.pause()
        syncMediaControls('pause',-1)

    }else if(e.type == 'seeked'){
        console.log("audio seeked ",audio.currentTime)
        audio.pause();
        video.currentTime = audio.currentTime;
        syncMediaControls('seeked',audio.currentTime)
        
    }else if(e.type == 'timeupdate'){
        console.log("audio timeupdate")
        syncMediaControls('timeupdate',-1)
    }
  }



function mainVideoControlShow(id,callback){
    //console.log("모바일 여기까지 왔냐? ", id)
    //if((params.open === true || params.open === 'true')){ // 개설자 -> 공유중 src정보를 가지고있어야함
    //    tempAudioSrc = '';
    //    tempVideoSrc = '';
    //}

    //var video = document.querySelector('video[id="' + id + '"]');
    //var video2 = document.getElementById('main-video');
    //video2.style.display = 'none';
    //video2.muted = true;
    //video2.volume = 0;
    //video2.srcObject = video.srcObject;
    //let stream = connection.streamEvents[id].stream;
    sharedCameraStream = id;
    clearMedia();
    video.srcObject = makeStreamByStreamID(id);
    //console.log("비디오에 할당헀나? ",video.srcObject);
    video.muted = true;
    video.volume = 0;
    $('#main-video').show(); // 선택된 비디오 메인비디오에 띄우기 <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<< 여기
    callback(); // 캔버스에 메인비디오 이식
}
function makeStreamByStreamID(id){
    return connection.streamEvents[id].stream
}
function changeMemoBtn(input){
    if(input){ // 메모창
        $('#btn-memo-message').attr('disabled', false);
        $("#isMemo").css('display', '');

        // 사용자 화면 위치 변경
        $("#captiondiv").css("display","none");
        $(".media-div").addClass("on");
        $(".user-info-label").addClass("on");
        $("#other-videos").addClass("on");
        $(".paging-button").addClass("on");
        // $("#isNomal").css('display', 'none');
        
    }else{ // nomal
        $('#btn-memo-message').attr('disabled', true);
        $("#isMemo").css('display', 'none');
        
        // 사용자 화면 위치 되돌리기
        $("#captiondiv").css("display","block");
        $(".media-div").removeClass("on");
        $(".user-info-label").removeClass("on");
        $("#other-videos").removeClass("on");
        $(".paging-button").removeClass("on");
        // $("#isNomal").css('display', '');
    }
    // console.log(btn_memo_flag)
}
function changeRecordBtn(input){
    btn_record_flag = input;
    if(btn_record_flag){
        $("#btn-record-message").html("Stop")
    }else{
        $("#btn-record-message").html("Start")
    }
}
$('#btn-record-message-m').click(function(){
    btn_record_flag = !btn_record_flag;
    if(btn_record_flag){
        if(!btn_memo_flag){
            swal("공유중인 화면이 없습니다.")
            btn_record_flag = false;
            return;
        }
        designer.postMessage({
            recording: true,
            content : true
        });
        audioRecord(startAudioRecord);
    }else{
        designer.postMessage({
            recording: true,
            content : false
        });
        stopAudioRecord();
        recordClock(); // 녹화한 미디어와 추가 입력 받아서 서버로 보내는 함수
    }
    changeRecordBtn(btn_record_flag)
})
$('#btn-record-message').click(function(){
    btn_record_flag = !btn_record_flag;
    if(btn_record_flag){
        if(!btn_memo_flag){
            swal("공유중인 화면이 없습니다.")
            btn_record_flag = false;
            return;
        }
        designer.postMessage({
            recording: true,
            content : true
        });
        audioRecord(startAudioRecord);
    }else{
        designer.postMessage({
            recording: true,
            content : false
        });
        stopAudioRecord();
        recordClock(); // 녹화한 미디어와 추가 입력 받아서 서버로 보내는 함수
    }
    changeRecordBtn(btn_record_flag)
});
function recordClock(){
    let getVideo = $('iframe').get(0).contentWindow.getRecordVideoFormData;
    if(!recordAudioFormData || !(recordVideoFormData = getVideo() )){
        let timerId = setTimeout(recordClock, 500);
        
    }else{
        swal({
            title: "SAVE RECORD",
            text: "녹화한 미디어를 저장하시겠습니까?",
            icon: "info",
            buttons: true,
            dangerMode: false,
          })
          .then((willDelete) => {
            if (willDelete) {
                $('#mediaFormToSave').modal('show');
            } else {
                swal("RECORD MEDIA", "미디어 저장을 취소 하였습니다!", "warning");
            }
          });


        //if(!confirm("녹화한 미디어를 저장하시겠습니까?")){
        //    
        //    recordVideoFormData = null;
        //    recordAudioFormData = null;
        //    swal("RECORD MEDIA", "미디어 저장을 취소 하였습니다!", "warning");
            //swal("취소 하였습니다!")
        //    return;
        //}else{
        //    $('#mediaFormToSave').modal('show');
        //}
    }
}
let myRecordedData = [];
$('#btn-save-record-media-modal').click(function(){
    if(!$('#txt-media-title').val().toString()){
        swal("저장할 이름을 입력해주세요.")
        return;
    }
    $('#btn-save-record-media-modal').attr('disabled', true);
    $('.modal-close-btn').attr('disabled', true);

    var fd = new FormData();
    fd.append('media_title', $('#txt-media-title').val().toString());
    fd.append('recordVideoFormData', recordVideoFormData);
    fd.append('recordAudioFormData', recordAudioFormData);
    $.ajax({
        url: 'https://k3d106.p.ssafy.io/api/v2/media/'+params.userFullName,
        type: 'POST',
        data: fd,
        processData: false,
        contentType: false,
        dataType: "json",
        enctype: "multipart/form-data",
        success: function (html) {
            recordVideoFormData = null;
            recordAudioFormData = null;
            //console.log("success");
          },
          error: function (error) {
            $('#btn-save-record-media-modal').attr('disabled', false);
            $('.modal-close-btn').attr('disabled', false);
            //recordVideoFormData = null;
            //recordAudioFormData = null;
            $('#mediaFormToSave').modal('hide');
          },
    }).done(function(data) {
        //console.log(data)
        $('#btn-save-record-media-modal').attr('disabled', false);
        $('.modal-close-btn').attr('disabled', false);
        //recordVideoFromData2 = b64toBlob(data.video,"video/mp4",512);
        //recordAudioFormData2 = b64toBlob(data.audio,"audio/webm;codecs=opus",512);
        //console.log("받은 비디오 ? ", b64toBlob(data.video,"video/mp4",512))
        //console.log("받은 오디오 ? ", b64toBlob(data.audio,"audio/webm;codecs=opus",512))
        //console.log("가지고있던 비디오 ? ",recordVideoFormData )
        //console.log("가지고있던 오디오 ? ",recordAudioFormData )
        //shareMyMedia(b64toBlob(data.video,"video/mp4",512),b64toBlob(data.audio,"audio/webm;codecs=opus",512));
        if(data.message == 'success')
            //swal("저장되었습니다!!!")
            swal("RECORD MEDIA", "저장되었습니다 !", "success");
            if(!$("#saveboxact").hasClass("active")){ // 이미 활성상태이면
                selectAllMedia()
            }
        $('#mediaFormToSave').modal('hide');
    });
});
function b64toBlob(b64Data, contentType='', sliceSize=512) {
    
    const byteCharacters = atob(b64Data);
    const byteArrays = [];
  
    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
      const slice = byteCharacters.slice(offset, offset + sliceSize);
  
      const byteNumbers = new Array(slice.length);
      for (let i = 0; i < slice.length; i++) {
        byteNumbers[i] = slice.charCodeAt(i);
      }
  
      const byteArray = new Uint8Array(byteNumbers);
      byteArrays.push(byteArray);
    }
  
    const blob = new Blob(byteArrays, {type: contentType});
    return blob;
  }
$('.modal-close-btn').click(function(){
    swal("취소 하였습니다!")
    recordVideoFormData = null;
    recordAudioFormData = null;
    $('#mediaFormToSave').modal('hide');
})
$('#btn-memo-message-m').click(function(){
    btn_memo_flag = !btn_memo_flag
    if(btn_memo_flag){
        connection.send('plz-memo-to-true')
    }else{
        if(isShareVideo || isMediaSharing){
            if(isShareMyVideo || isShareMyMedia){
                swal("공유가 중지되었습니다.")
                changeShareMyCamera(false);
            }
            connection.send({
                mainVideo: 'plz-remove-main-video'
            });
            mainVideoControlHide(designer.removeMainVideo);
        }
        designer.backgroundWhite();
        connection.send("plz-memo-to-false")
    }
    changeMemoBtn(btn_memo_flag)
})
$('#btn-memo-message').click(function() {
    btn_memo_flag = !btn_memo_flag
    if(btn_memo_flag){
        connection.send('plz-memo-to-true')
    }else{
        if(isShareVideo || isMediaSharing){
            if(isShareMyVideo || isShareMyMedia){
                swal("공유가 중지되었습니다.")
                changeShareMyCamera(false);
            }
            connection.send({
                mainVideo: 'plz-remove-main-video'
            });
            mainVideoControlHide(designer.removeMainVideo);
        }
        designer.backgroundWhite();
        connection.send("plz-memo-to-false")
    }
    changeMemoBtn(btn_memo_flag)
});
$('#btn-white-board').click(function(){
    if(!btn_memo_flag){
        btn_memo_flag = true
        changeMemoBtn(true)
        connection.send('plz-memo-to-true') 
    }
    if(isShareVideo || isMediaSharing){
        if(isShareMyVideo || isShareMyMedia){
            swal("공유가 중지되었습니다.")
            mainVideoControlHide(designer.removeMainVideo);
            connection.send({
                mainVideo: 'plz-remove-main-video'
            });
            designer.backgroundWhite();
            changeShareMyCamera(false);
        }
        //else if(!confirm("지금 타사용자가 미디어를 공유중입니다. 타사용자의 미디어공유를 중지하시겠습니까?")){
        //    return;
        //}
        else{
            swal({
                title: "STOP SHARING",
                text: "지금 타사용자가 미디어를 공유중입니다. 타사용자의 미디어공유를 중지하시겠습니까?",
                icon: "warning",
                buttons: true,
                dangerMode: false,
              })
              .then((willDelete) => {
                if (willDelete) {
                    //$('#mediaFormToSave').modal('show');
                    swal("SHARING", "화이트보드를 공유합니다", "success");
                    mainVideoControlHide(designer.removeMainVideo);
                    connection.send({
                        mainVideo: 'plz-remove-main-video'
                    });
                    designer.backgroundWhite();
                } else {
                    swal("STOP SHARING", "화이트 보드 공유를 취소합니다", "warning");
                    return;
                }
              });
        }

        //mainVideoControlHide(designer.removeMainVideo);
    }
})
$("#btn-white-board-m").click(function(){
    if(!btn_memo_flag){
        btn_memo_flag = true
        changeMemoBtn(true)
        connection.send('plz-memo-to-true') 
    }
    if(isShareVideo || isMediaSharing){
        if(isShareMyVideo || isShareMyMedia){
            swal("공유가 중지되었습니다.")
            changeShareMyCamera(false);
        }else{
            swal({
                title: "STOP SHARING",
                text: "지금 타사용자가 미디어를 공유중입니다. 타사용자의 미디어공유를 중지하시겠습니까?",
                icon: "warning",
                buttons: true,
                dangerMode: false,
              })
              .then((willDelete) => {
                if (willDelete) {
                    //$('#mediaFormToSave').modal('show');
                    swal("SHARING", "화이트보드를 공유합니다", "success");
                    mainVideoControlHide(designer.removeMainVideo);
                    connection.send({
                        mainVideo: 'plz-remove-main-video'
                    });
                    designer.backgroundWhite();
                } else {
                    swal("STOP SHARING", "화이트 보드 공유를 취소합니다", "warning");
                    return;
                }
              });
        }
    }
    connection.send({
        mainVideo: 'plz-remove-main-video'
    });
    designer.backgroundWhite();
})
$('#btn-clear-message').click(function() {
    clearCanvas();
});
$('#btn-clear-message-m').click(function() {
    clearCanvas();
});
function clearCanvas(){
    let clearFlag = false;
    if(document.querySelector("#main-video").style.display !== "none"){
        clearFlag = true; // 캔버스 배경영상이 있을때
    }
    designer.postMessage({
        undo: true,
        index : "all",
        clearFlag : clearFlag
    });
    connection.send("plz-clear-canvas")
}

function syncSharedMedia2Image(sharedImage){
    isShareMyVideo = false;
    isShareVideo = false;
    isMediaSharing = true; // 미디어 공유중인지?
    isShareMyMedia = false; // 자기 미디어 공유중인지? - 제어권 가짐
    
    image.src = sharedImage;
    //$('#main-video').show();
    designer.backgroundImage();
    
}

function syncSharedMedia(recordAudioFormData,recordVideoFormData){
    isShareMyVideo = false;
    isShareVideo = false;
    isMediaSharing = true; // 미디어 공유중인지?
    isShareMyMedia = false; // 자기 미디어 공유중인지? - 제어권 가짐
    
    video.controls = false;
    audio.controls = false; 

    audio.src = recordAudioFormData;
    video.src = recordVideoFormData;
    audio.pause();
    video.pause();
    //$('#main-video').show();
    designer.backgroundVideo();
    
}

function makeShareMediaSrc2Image(recordVideoFormData2){
    var imageReader = new FileReader();
        imageReader.onloadend = function() {
            tempImageSrc = imageReader.result
        }
    imageReader.readAsDataURL(recordVideoFormData2);
    sendMediaClock2Image();

}
function makeShareMediaSrc(recordVideoFormData2,recordAudioFormData2){
    var videoReader = new FileReader();
    var audioReader = new FileReader();

    audioReader.onloadend = function() {
        tempAudioSrc = audioReader.result;   
        //console.log("tempAudioSrc",tempAudioSrc)     
    }
    videoReader.onloadend = function() {
        tempVideoSrc = videoReader.result;    
        //console.log("tempVideoSrc",tempVideoSrc)     
    }
    audioReader.readAsDataURL(recordAudioFormData2);
    videoReader.readAsDataURL(recordVideoFormData2);
    sendMediaClock();
}
function initIntaval(){ // 문제 될수있을듯
    connection.chunkInterval = 0;
}

function sendMediaClock2Image(){
    if(!tempImageSrc){
        let timerId = setTimeout(sendMediaClock2Image, 500);
    }else{
        sendMediaSrc2Image(tempImageSrc);
        tempImageSrc = "";
    }
}
function sendMediaClock(){
    if(!tempAudioSrc || !tempVideoSrc){
        let timerId = setTimeout(sendMediaClock, 500);
    }else{
        sendMediaSrc(tempAudioSrc,tempVideoSrc);
        tempAudioSrc = "";
        tempVideoSrc = "";
    }
}

function sendMediaSrc2Image(sharedRecordVideo,callback){
    connection.chunkInterval = 0.00000000001;
    image.src = sharedRecordVideo
    if(connection.getAllParticipants().length >= 1){        
        connection.send({
            type:"sendMedia",
            sharedImage: 'plz-get-shared-image',
            sharedSaveImage : sharedRecordVideo,
            checkmark_id : connection.userid,
            requestId : connection.extra.userFullName
        });
    }else{
        swal("저장된 미디어를 불러오고있습니다.")
        finishShareMidia = true;
        initIntaval();
        setTimeout(loadDuration,500,false)
        return;
    }
    //audio.src = sharedRecordAudio
    //video.src = sharedRecordVideo
    
    //$('#main-video').show();
    //audio.style.display = '';
    //designer.backgroundVideo();
    //video.pause();
    //audio.pause();
}
function sendMediaSrc(sharedRecordAudio,sharedRecordVideo,callback){
      
    connection.chunkInterval = 0.00000000001;
    audio.src = sharedRecordAudio
    video.src = sharedRecordVideo
    audio.pause();
    video.pause();
    if(connection.getAllParticipants().length >= 1){        
        connection.send({
            type:"sendMedia",
            sharedVideo: 'plz-get-shared-video',
            sharedRecordAudio : sharedRecordAudio,
            sharedRecordVideo : sharedRecordVideo,
            checkmark_id : connection.userid,
            requestId : connection.extra.userFullName
        });
    }else{
        swal("저장된 미디어를 불러오고있습니다.")
        finishShareMidia = true;
        initIntaval();
        setTimeout(loadDuration,500,true)
        return;
    }
    //audio.src = sharedRecordAudio
    //video.src = sharedRecordVideo
    
    //$('#main-video').show();
    //audio.style.display = '';
    //designer.backgroundVideo();
    //video.pause();
    //audio.pause();
}
function clearMedia(){
    //console.log("CLEARMEDIA")
    audio.srcObject = null;
    audio.removeAttribute('src')
    //audio.onended = function(e) {
        //audio.srcObject = null;
        //audio.src = null;
        // audio.style.display = 'none';
      //  audio.pause();
      //  video.pause();
    //};
    audio.style.display = 'none';
    video.srcObject = null;
    video.removeAttribute('src')
    video.style.display = 'none';
    //video.onended = function(e) {
        //video.srcObject = null;
        //video.src = null;
        //video.style.display = 'none';
        //designer.postMessage({
        //    removeMainVideo: true
        //});
        //audio.pause();
        //video.pause();
    //};
    video.controls = false;
    audio.controls = false;    

    image.src = null;
}

function selectAllMedia(){
    $.ajax({
        type: "GET",
        url: 'https://k3d106.p.ssafy.io/api/v2/media/'+params.userFullName,
        success: function (html) {},
        error: function (error) {},
    }).done(function(data) {
        console.log(data.media)
        if(data.media.length){
            let table = document.createElement('table');
            let tbody = document.createElement('tbody')
            table.id = 'uploaded-table'
            table.className = 'table';
            // table.innerHTML = `<thead><tr><th>제목</th><th>업로드 날짜</th></tr></thead>`;
            tbody.id = 'uploadDatas';
            let temp = '';
            for(let i=data.media.length-1;i>=0;i--){
                if(data.media[i].is_video){
                    temp += '<tr class="media-element"><td><img class="rec_class" src="../img/video.png"></td><td >'+data.media[i].media_title+'</td><td>'+uploadDate(data.media[i].video_upload_time)+'</td></tr>';
                }else{
                    temp += '<tr class="media-element"><td><img class="rec_class" src="../img/image.png"></td><td>'+data.media[i].media_title+'</td><td>'+uploadDate(data.media[i].video_upload_time)+'</td></tr>';
                }
            }
            tbody.innerHTML = temp;
            table.appendChild(tbody);
            $("#uploaded-list").empty();
            console.log("table>>>>>>>>>>>>>>>",table);
            document.getElementById("uploaded-list").appendChild(table)
        }else{
            let div = document.createElement('div');
            div.innerHTML = '기록 영상이 없습니다';
            $("#uploaded-list").empty();
            document.getElementById("uploaded-list").appendChild(div)
        }
        // 여기서 테이블 만들기
    });
}
function uploadDate(string){
    let subString = string.substr(0,string.indexOf('T'))
    return subString;
}
$(document).on("click",".media-element",function(){
    if(!isShareMyVideo && !isShareMyMedia  ){
        if(isShareVideo || isMediaSharing  ){
            if(!confirm("지금 타사용자가 화면을 공유중입니다. 저장된 미디어를 공유 하시겠습니까?")){
                return;
            }
        }
    }
    
    var tr = $(this);
    var td = tr.children();
    var title = td.eq(1).text();
    //let searchFromServer = confirm("저장된" + title + " 미디어를 공유하시겠습니까?");

    swal({
        title: "MEDIA SHARING",
        text: "저장된" + title + " 미디어를 공유하시겠습니까?",
        icon: "info",
        buttons: true,
        dangerMode: false,
      })
      .then((willDelete) => {
        if (willDelete) {
            //$('#mediaFormToSave').modal('show');
            //swal("SHARING", "미디어를 공유합니다", "success");
            if(!btn_memo_flag){
                if(init_btn_sync || init_share_media){
                    init_btn_sync = true; // 방버튼정보를 최초 동기화 하였는가??
                    init_share_media = true; // share정보 최초 동기화 하였는가??
                }
                btn_memo_flag = true; // 회의화면 or canvas화면 btn
                connection.send("plz-memo-to-true")
                changeMemoBtn(btn_memo_flag)
            }
            getMidiasFromDB(title)
        } else {
            swal("STOP SHARING", "미디어 공유를 취소합니다", "warning");
            return;
        }
      });


    //if(searchFromServer){
    //    if(!btn_memo_flag){
    //        if(init_btn_sync || init_share_media){
    //            init_btn_sync = true; // 방버튼정보를 최초 동기화 하였는가??
    //            init_share_media = true; // share정보 최초 동기화 하였는가??
    //        }
    //        btn_memo_flag = true; // 회의화면 or canvas화면 btn
    //        connection.send("plz-memo-to-true")
    //        changeMemoBtn(btn_memo_flag)
    //    }
    //    getMidiasFromDB(title)

    //}
}); 

function getMidiasFromDB(title){
    console.log("GETMIDA")
    $.ajax({
        type: "GET",
        url: 'https://k3d106.p.ssafy.io/api/v2/media/'+params.userFullName+"/"+title,
       //url: 'https://k3d106.p.ssafy.io/api/v2/test/5/moblie',
        success: function (html) {

        },
        error: function (error) {

        },
    }).done(function(data) {
        console.log(data)
        if("success" === data.message){
            if(data.audio){
                shareMyMedia(b64toBlob(data.video,"video/mp4",512),b64toBlob(data.audio,"audio/webm;codecs=opus",512)) // 디코딩
                   //shareMyMedia2(b64toBlob(data.video,"video/mp4",512)) // 디코딩
            }else{
                console.log("이미지다!")
                shareMyMedia2Image(b64toBlob(data.video,"image/*",512)) // 디코딩
            }
            isShareMyVideo = false;
            isShareVideo = false;
            isMediaSharing = true;
            isShareMyMedia = true;
        }
    });
}
// 모바일
function shareMyMedia2Image(recordVideoFromData2){ // 저장된 정보로 share하는 함수
    console.log("shareMyMedia2 ! ", recordVideoFromData2)
    toShareCnt = connection.getAllParticipants().length;
    receiveCnt = 0;
    finishShareMidia = false;
    clearCanvas(); // 적던것 지우고 시작
    clearMedia();
    makeShareMediaSrc2Image(recordVideoFromData2);
}
function moblieClickParticipant(id){

    var list = ['participant-boxid', 'chat-boxid', 'save-boxid'];
    var listTitle = ['참가자','채팅','보관함'];
    for(var i=0; i<list.length; i++){
        if(list[i]==id){
            $(".mobile-title").html(listTitle[i]);
            var tempClassName = '#'+list[i]+'';
            $(tempClassName).removeClass('active');
            $(tempClassName).removeClass('off');
            $(tempClassName).addClass('on');

            if(id=='chat-boxid'){
                $('.chat-box').removeClass('active');
            }else{
                $('.chat-box').addClass('active');
            }

            if(id=='save-boxid'){
                $('.save-box').removeClass('active');
                selectAllMedia();
            }else{
                $('.save-box').addClass('active');
            }
        }
        else{
            var tempClassName = '#'+list[i]+'';
            $(tempClassName).addClass('active');
            $(tempClassName).removeClass('on');
            $(tempClassName).addClass('off');
        }
    }
    
    $('#sidebar').addClass('on');
    // $('.sidebar').css("display","none");
    $('.back').css("display","block");
    $('.btn-zip').css("display","none");
    $('.mobile-title').css("display","block");

}

function mobileClickBack(){
    $('#sidebar').removeClass('on');
    // $('.sidebar').css("display","block");
    $('.btn-zip').css("display","none");
    $('.back').css("display","none");
    $('.mobile-title').css("display","none");
    
}
function shareMyMedia(recordVideoFromData2,recordAudioFormData2){ // 저장된 정보로 share하는 함수
    toShareCnt = connection.getAllParticipants().length;
    receiveCnt = 0;
    console.log("toShareCnt ", toShareCnt)
    finishShareMidia = false;
    clearCanvas(); // 적던것 지우고 시작
    clearMedia();
    makeShareMediaSrc(recordVideoFromData2,recordAudioFormData2);
}
function audioRecord(callback){
    console.log("audioRecord 실행")
    streamArr = [];
    connection.streamEvents.selectAll().forEach(ele=>{
        streamArr.push(ele.stream)
    });
    callback();
}
function startAudioRecord(){
    console.log("callback 함수 실행")
    recorder = RecordRTC(streamArr, {
        type: 'audio'
      });
    connection.recorder = recorder;
    console.log("RECORDER START! ",recorder);
    recorder.startRecording();
}

async function loadDuration(isVideo){
    if(isVideo){
        while(audio.duration === Infinity) {
            await new Promise(r => setTimeout(r, 1000));
            audio.currentTime = 10000000*Math.random();
        }
        audio.style.display = '';
        audio.currentTime = 0;
        video.controls = false;
        audio.controls = true; 
        designer.backgroundVideo();
        video.pause();
        audio.pause();
    }else{
        designer.backgroundImage();
    }
}

function stopAudioRecord() {
  var recorder = connection.recorder;
  if(!recorder) return swal('No recorder found.');
  recorder.stopRecording(function() {
    var blob = recorder.getBlob();
    var audioURL = URL.createObjectURL(blob); 
    console.log("녹화된 결과값 : ",blob)
    recordAudioFormData = blob;
    connection.recorder = null;
  });
};
let myStreamID;
let isShareVideo = false;
let isShareMyVideo = false;
let sharedCameraStream = '';
// 1112 페이징처리 코드확인하고 진행할것
function toggleShareMyCamera(flag){
    if(flag){ // 화면공유
        if((isShareVideo && isShareMyVideo) || (isMediaSharing  && !isShareMyMedia)){ // 카메라 공유를 하려고하는데 이미 공유중인경우 (앞)
            if(!confirm("지금 타사용자가 화면을 공유중입니다. 화면공유 하시겠습니까?")){
                isShareMyVideo = false;
                changeShareMyCamera(false)
                return;
            }
        }
        mainVideoControlShow(myStreamID,designer.backgroundVideo);
        connection.send({
            mainVideo: 'plz-find-main-video',
            mainVideoId: myStreamID,
            requestId: connection.extra.userFullName
        });
        
        isShareMyVideo = true;
        isShareVideo = true;
        isMediaSharing = false; // 미디어 공유중인지?
        isShareMyMedia = false; // 자기 미디어 공유중인지? - 제어권 가짐 -> 아직 개발단계
        
        
        finishShareMidia = false; // 공유가 끝났는지?
        audio.pause();
        
    }else{ // 공유중지
        if(!video.srcObject && !video.src) return;
        connection.send({
            mainVideo: 'plz-remove-main-video'
        });
        mainVideoControlHide(designer.removeMainVideo);
        designer.backgroundWhite();
    }
}
function changeShareMyCamera(flag){
    if(flag){
        $("#btn-share-my-camera").html("StopShareMyCamera")
    }else{
        $("#btn-share-my-camera").html("ShareMyCamera")
    }
}
$('#btn-share-my-camera').click(function(){
    isShareMyVideo = !isShareMyVideo;//true false 확인?
    if(isShareMyVideo && !btn_memo_flag){
        btn_memo_flag = true //그림판
        changeMemoBtn(true)
        connection.send('plz-memo-to-true') 
    }
    changeShareMyCamera(isShareMyVideo)
    toggleShareMyCamera(isShareMyVideo)
})
//mobile ver
function changeShareMyCameraM(flag){
    if(flag){
        $("#btn-share-my-camera-m").html("StopShareMyCamera")
    }else{
        $("#btn-share-my-camera-m").html("ShareMyCamera")
    }
}
$('.sidebar-i').click(function(){
    if(!DetectRTC.isMobileDevice){
        return;
    }
    if(document.querySelector("#menuicon").checked){
        document.querySelector("#menuicon").checked = false
    }
    console.log(" 확인용 입니다 . ",document.querySelector("#menuicon").checked);
})
$('#btn-share-my-camera-m').click(function(){
    isShareMyVideo = !isShareMyVideo;//true false 확인?
    if(isShareMyVideo && !btn_memo_flag){
        btn_memo_flag = true //그림판
        changeMemoBtn(true)
        connection.send('plz-memo-to-true') 
    }
    changeShareMyCameraM(isShareMyVideo)
    toggleShareMyCamera(isShareMyVideo)
})
//$('#other-videos').click(function(e){  // 방장만 타 사용자에게 공유요청을 보낼수있게? -> 개발할지말지 의논해보고 진행하자
//    if(params.open === true || params.open === 'true'){
//            var id = e.target.getAttribute('id');
//            if ( ( id != '') && (id != null)) {
//            //console.log("parent document : ",e.target)
//            mainVideoControlShow(id,designer.backgroundVideo);
//            console.log(e.target)
//            connection.send({
//                mainVideo: 'plz-find-main-video',
//                mainVideoId: id
//            });
//            isMediaSharing = false; // 미디어 공유중인지?
//            isShareMyMedia = false; // 자기 미디어 공유중인지? - 제어권 가짐 -> 아직 개발단계
//            finishShareMidia = false; // 공유가 끝났는지?
//            audio.pause();
//            video.controls = false;
//            audio.controls = false;
//        }   
//    }
//});
//$('#main-video').click(function(e){ // main-video 지우는로직 적을것
//    console.log("SRCSRCSRC",document.querySelector("#main-video").srcObject)
//    console.log("SRCSRCSRC",document.querySelector("#main-video").src)
//    if(!document.querySelector("#main-video").srcObject && !document.querySelector("#main-video").src) return;
//    connection.send({
//        mainVideo: 'plz-remove-main-video'
//    });
//    mainVideoControlHide(designer.removeMainVideo);

//});
function mainVideoControlHide(callback){
    //if((params.open === true || params.open === 'true')){ // 개설자 -> 공유중 src정보를 가지고있어야함
    //    tempAudioSrc = '';
    //    tempVideoSrc = '';
    //}
    isShareVideo = false;
    isShareMyVideo = false;
    isMediaSharing = false; 
    isShareMyMedia = false;
    sharedCameraStream = '';
    clearMedia();
    $('#main-video').hide();
    callback();
}

(function() {    
    var params = {},
        r = /([^&=]+)=?([^&]*)/g;

    function d(s) {
        return decodeURIComponent(s.replace(/\+/g, ' '));
    }
    var match, search = window.location.search;
    while (match = r.exec(search.substring(1)))
        params[d(match[1])] = d(match[2]);
    window.params = params;
})();

var connection = new RTCMultiConnection();

connection.socketURL = '/';
//connection.socketURL = 'https://rtcmulticonnection.herokuapp.com:443/';
//connection.socketURL = 'http://localhost:9002/';

connection.extra.userFullName = params.userFullName; // 사번
getUsersByID(params.userFullName);

function getUsersByID(id){
    $.ajax({
        type: "GET",
        url: 'https://k3d106.p.ssafy.io/api/v2/users/'+params.userFullName,
        // token헤더에 넣는 방식으로 바꿀것. 토큰은 session이든 로컬스토리지를 통해 가져올것
        //beforeSend: function (xhr) {
        //    xhr.setRequestHeader("Content-type","application/json");
        //    xhr.setRequestHeader("Authorization","JWT " + token);
        //},
        success: function (html) {},
        error: function (error) {},
    }).done(function(data) {
        connection.extra.userInfo = data.user;
    });
}

/// make this room public
connection.publicRoomIdentifier = params.publicRoomIdentifier;

connection.socketMessageEvent = 'canvas-dashboard-demo';

// keep room opened even if owner leaves
connection.autoCloseEntireSession = true;

// https://www.rtcmulticonnection.org/docs/maxParticipantsAllowed/
connection.maxParticipantsAllowed = 1000;
// set value 2 for one-to-one connection
// connection.maxParticipantsAllowed = 2;

// here goes canvas designer
var designer = new CanvasDesigner();

// you can place widget.html anywhere

// 추가된 코드
designer.widgetHtmlURL = '/dist/canvas-designer/widget.html';
designer.widgetJsURL = '/dist/canvas-designer/widget_mod.js'
// 추가

designer.addSyncListener(function(data) {
    connection.send(data);
});

designer.setSelected('pencil');

designer.setTools({
    pencil: true,
    text: false,
    image: true,
    pdf: false,
    eraser: false,
    line: false,
    arrow: false,
    dragSingle: false,
    dragMultiple: true,
    arc: true,
    rectangle: true,
    quadratic: false,
    bezier: false,
    marker: true,
    zoom: false,
    lineWidth: false,
    colorsPicker: false,
    extraOptions: false,
    code: false,
    undo: false
});

// here goes RTCMultiConnection

connection.chunkSize = 60000; // 16000 -> 160000 / 80000
connection.enableFileSharing = true;

connection.session = {
    audio: true,
    video: true,
    data: true,
};
connection.sdpConstraints.mandatory = {
    OfferToReceiveAudio: true,
    OfferToReceiveVideo: true
};

connection.onUserStatusChanged = function(event) {
    //var infoBar = document.getElementById('onUserStatusChanged');
    var userInfo = [];
    connection.getAllParticipants().forEach(function(pid) {
        userInfo.push(getUserInfo(pid));
    });

    if(userInfo.length) {
        userInfo = [connection.extra.userInfo].concat(userInfo);
    }
    if(userInfo.length){
        let table = document.createElement('table');
        let tbody = document.createElement('tbody')
        table.id = 'participant-table'
        table.className = 'table';
        table.innerHTML = `<thead><tr><th>부서</th><th>이름</th><th>직급</th></tr></thead>`;
        tbody.id = 'user-datas';
        let temp = '';
        for(let i=0;i<userInfo.length;i++){
            temp += '<tr><td>'+userInfo[i].user_dept+'</td><td>'+userInfo[i].user_name+'</td><td>'+userInfo[i].user_grade+'</td></tr>';
        }
        tbody.innerHTML = temp;
        table.appendChild(tbody);
        $("#participant-list").empty();
        document.getElementById("participant-list").appendChild(table)
    }else{
        let div = document.createElement('div');
        div.className = 'wait';
        div.innerHTML = '다른멤버가 참여할 때까지 기다려주세요';
        $("#participant-list").empty();
        document.getElementById("participant-list").appendChild(div)
    }
    //infoBar.innerHTML = '<b>미팅 멤버:</b> ' + names.join(', ');
};

connection.onopen = function(event) {
    connection.onUserStatusChanged(event);

    if (designer.pointsLength <= 0) {
        // make sure that remote user gets all drawings synced.
        setTimeout(function() {
            connection.send('plz-sync-points');
        }, 1000);
    }

    document.getElementById('btn-chat-message').disabled = false;
    document.getElementById('btn-attach-file').style.display = 'inline-block';
    //document.getElementById('btn-share-screen').style.display = 'inline-block';
};

connection.onclose = connection.onerror = connection.onleave = function(event) {
    connection.onUserStatusChanged(event);
};

function syncMediaControls(string, param){
    console.log("can control shared media? ", isShareMyMedia)
    if(!isShareMyMedia) return;
    if ('play'=== string) {
        connection.send({
            type:"syncMediaControls",
            mediaControls: 'plz-media-play',
        });
    }else if ('pause' === string) {
        connection.send({
            type:"syncMediaControls",
            mediaControls: 'plz-media-pause',
        });
    }else if('seeked' === string){
        connection.send({
            type:"syncMediaControls",
            mediaControls: 'plz-media-seeked',
            currentTime: param,
        });
    }else if('timeupdate' === string){
        connection.send({ // 추가 구현
            type:"syncMediaControls",
            mediaControls: 'plz-media-timeupdate',
            timeupdate: param,
        });
      }
}
let toShareCnt = -1;
let receiveCnt = -1;
connection.onmessage = function(event) {
    //console.log("메시지 받았다!!",event.data)
    if("syncMediaControls" === event.data.type){
        if('plz-media-play'===event.data.mediaControls){
            audio.play();
        }else if('plz-media-pause'===event.data.mediaControls){
            audio.pause();
        }else if('plz-media-seeked'===event.data.mediaControls){
            audio.pause();
            audio.currentTime = event.data.currentTime;
        }else if('plz-media-timeupdate'===event.data.mediaControls){
            console.log("time update ???? ")
        }
        return;
    }
    if(event.data.showMainVideo) {
        // $('#main-video').show();
        console.log("받았는데?")
        $('#screen-viewer').css({
            top: $('#widget-container').offset().top,
            left: $('#widget-container').offset().left,
            width: $('#widget-container').width(),
            height: $('#widget-container').height()
        });
        $('#screen-viewer').show();
        return;
    }
    if(event.data.receive_success){
        if(event.data.target_id === connection.userid){
            if(!event.data.need_time_sync){
                receiveCnt++;
                if(receiveCnt == toShareCnt || toShareCnt != connection.getAllParticipants().length){
                    toShareCnt = -1;
                    receiveCnt = -1;
                    //swal("미디어 공유가 완료되었습니다.")
                    swal("SHARE MEDIA", "미디어 공유가 완료되었습니다.", "success");
                    finishShareMidia = true;
                    console.log("isShareMyMedia",isShareMyMedia)
                    initIntaval();
                    if(isShareMyMedia){ 
                        if(event.data.isVideo){
                            loadDuration(true);
                        }else{
                            loadDuration(false);
                        }
                    }
                }
            }else{
                initIntaval();
            }
        }
        return;
    }
    
    if(event.data.sharedImage === 'plz-get-shared-image'){
        if(event.data.sharedSaveImage){
            if(!event.data.target_id){
                if(event.data.checkmark_id){
                    connection.send({
                        receive_success : true,
                        target_id : event.data.checkmark_id,
                        need_time_sync : false,
                        isVideo : false,
                    })
                    finishShareMidia = true; 
                }
                if(isShareMyVideo){
                    swal(event.data.requestId +" 사용자의 공유 요청으로 카메라 공유가 중지됩니다.")
                    changeShareMyCamera(false);   
                    isShareMyVideo = false; 
                    isShareVideo = false;
                }else if(isShareMyMedia){
                    swal(event.data.requestId +" 사용자의 공유 요청으로 미디어 공유가 중지됩니다.")
                    isShareMyMedia = false;
                }
                clearMedia();
                syncSharedMedia2Image(event.data.sharedSaveImage);
            }
        }
    }
    if(event.data.sharedVideo ==='plz-get-shared-video'){
        if(event.data.sharedRecordAudio && event.data.sharedRecordVideo){
            if(!event.data.target_id){ // 미디어 공유 요청 받은사람
                //if(params.open === true || params.open === 'true'){ // 개설자 -> src정보를 가지고있어야함
                //    tempAudioSrc = event.data.sharedRecordAudio;
                //    tempVideoSrc = event.data.sharedRecordVideo;
                //}
                if(event.data.checkmark_id){
                    connection.send({
                        receive_success : true,
                        target_id : event.data.checkmark_id,
                        need_time_sync : false,
                        isVideo : true,
                    })
                    finishShareMidia = true; 
                }
                if(isShareMyVideo){
                    swal(event.data.requestId +" 사용자의 공유 요청으로 카메라 공유가 중지됩니다.")
                    changeShareMyCamera(false);   
                    isShareMyVideo = false; 
                }else if(isShareMyMedia){
                    swal(event.data.requestId +" 사용자의 공유 요청으로 미디어 공유가 중지됩니다.")
                    isShareMyMedia = false;
                }
                if(isShareMyVideo && isShareVideo){
                    changeShareMyCamera(false);
                }
                clearMedia();
                syncSharedMedia(event.data.sharedRecordAudio,event.data.sharedRecordVideo)
            }else if(event.data.target_id === connection.extra.userFullName){ // 늦게 들어온사람
                // receive_success 보내고나서 방장에게 시간정보 받아내야함.
                if(event.data.checkmark_id){
                    connection.send({
                        receive_success : true,
                        target_id : event.data.checkmark_id,
                        need_time_sync : true,
                        isVideo : true,
                    })
                    finishShareMidia = true; 
                    clearMedia();
                    syncSharedMedia(event.data.sharedRecordAudio,event.data.sharedRecordVideo)
                }
            }
        }
        return;
    }
    if(event.data.mainVideo === 'plz-find-main-video'){ // 비디오를 찾아서 메인비디오에 띄워라
        if(!event.data.target_id){
            if(isShareMyVideo){
                swal(event.data.requestId +" 사용자의 공유 요청으로 카메라 공유가 중지됩니다.")
                changeShareMyCamera(false);   
                isShareMyVideo = false; 
            }else if(isShareMyMedia){
                swal(event.data.requestId +" 사용자의 공유 요청으로 미디어 공유가 중지됩니다.")
                isShareMyMedia = false;
            }
            isShareVideo = true;
            isShareMyVideo = false;
            mainVideoControlShow(event.data.mainVideoId,designer.backgroundVideo);

            isMediaSharing = false; // 미디어 공유중인지?
            isShareMyMedia = false; // 자기 미디어 공유중인지? - 제어권 가짐 -> 아직 개발단계
            finishShareMidia = false; // 공유가 끝났는지?
            audio.pause();
            video.controls = false;
            audio.controls = false;
            return;
        }else if(event.data.target_id === connection.extra.userFullName){ // 방 초기정보 받는사람
            isShareVideo = true;
            isShareMyVideo = false;
            mainVideoControlShow(event.data.mainVideoId,designer.backgroundVideo);
            
            isMediaSharing = false; // 미디어 공유중인지?
            isShareMyMedia = false; // 자기 미디어 공유중인지? - 제어권 가짐 -> 아직 개발단계
            finishShareMidia = false; // 공유가 끝났는지?
            audio.pause();
            video.controls = false;
            audio.controls = false;
            return;
        }
    }
    if(event.data.mainVideo === 'plz-remove-main-video'){ // 메인비디오 지우기 + 화이트보드로 이동
        if(isShareVideo || isMediaSharing){
            if(isShareMyVideo || isShareMyMedia){
                swal("공유가 중지되었습니다.")
                changeShareMyCamera(false);
            }
            mainVideoControlHide(designer.removeMainVideo);
        }
        designer.backgroundWhite();
        return;
    }
    if(event.data.hideMainVideo) {
        // $('#main-video').hide();
        $('#screen-viewer').hide();
        return;
    }

    if(event.data.typing === true) {
        $('#key-press').show().find('span').html(event.extra.userFullName + ' is typing');
        return;
    }

    if(event.data.typing === false) {
        $('#key-press').hide().find('span').html('');
        return;
    }

    if (event.data.chatMessage) {
        appendChatMessage(event);
        return;
    }

    if (event.data.checkmark === 'received') {
        var checkmarkElement = document.getElementById(event.data.checkmark_id);
        if (checkmarkElement) {
            checkmarkElement.style.display = 'inline';
        }
        return;
    }

    if (event.data === 'plz-sync-points') { // 최초 싱크맞출때
        designer.sync();
        return;
    }
    if(event.data === 'plz-clear-canvas'){
        let clearFlag = true;
        //if(document.querySelector("#main-video").style.display !== "none"){
        //    console.log("if문 들어왔다")
        //    clearFlag = true; // 캔버스 배경영상이 있을때
        //}
        designer.postMessage({
            clearFlag : clearFlag
        });
        return;
    }
    if(event.data === 'plz-memo-to-false'){
        btn_memo_flag = false;
        changeMemoBtn(btn_memo_flag);
        return;
    }
    if(event.data === 'plz-memo-to-true'){
        btn_memo_flag = true;
        changeMemoBtn(btn_memo_flag);
        return;
    }
    if(event.data.request === 'init-plz-memo-to-false' && event.data.target_id === connection.extra.userFullName){
        //console.log("방버튼정보 받았다!")
        btn_memo_flag = false;
        init_btn_sync = true;
        changeMemoBtn(btn_memo_flag);
        return;
    }
    if(event.data.request === 'init-plz-memo-to-true' && event.data.target_id === connection.extra.userFullName){
        //console.log("초기화!")
        //console.log("방버튼정보 받았다!")
        btn_memo_flag = true;
        init_btn_sync = true;
        changeMemoBtn(btn_memo_flag);
        return;
    }
    if(event.data.request === 'plz-btn-sync' && (params.open === true || params.open === 'true')){
        if(btn_memo_flag){
            connection.send({
                request: 'init-plz-memo-to-true',
                target_id: event.data.join_id
            })
            if(isShareVideo){
                connection.send({
                    mainVideo: 'plz-find-main-video',
                    mainVideoId: sharedCameraStream,
                    target_id: event.data.join_id,
                });
            }
            //else if(isMediaSharing){
            //    connection.chunkInterval = 0.00000000001; 
            //    connection.send({
            //        type:"sendMedia",
            //        sharedVideo: 'plz-get-shared-video',
            //        sharedRecordAudio : tempAudioSrc,
            //        sharedRecordVideo : tempVideoSrc,
            //        checkmark_id : connection.userid,
            //        target_id: event.data.join_id
            //    }); 
            //}
        }else{
            connection.send({
                request: 'init-plz-memo-to-false',
                target_id: event.data.join_id
            })
        }
        return; 
    }

    designer.syncData(event.data);
};


// extra code

// 페이징 변수
var totalPeople = 0;
var tempCount = 4;
var meetingList = [];
var tempPageCount = 0;
var newHtml;
var currentPage = 1;
var dataPerPage = 4;    // 한 페이지에 나타낼 데이터 수
var pageCount = 1;        // 한 화면에 나타낼 페이지 수

// 모바일 화면 변수 설정
if($(window).width() <768) {
    tempCount = 2;
    dataPerPage = 2;
}
connection.onstream = function(event) {
    console.log("DETECT! ", DetectRTC)
    console.log("stream 은?!",connection.streamEvents)
    totalPeople++;  //누가 들어올 때 ++
    // 화면 크기 따른 함수 호출
    if($(window).width() >768) {
        inWeb(event);
    }else{
        inMobile(event);
    }
};


let otherStreamID;
function inWeb(event) {

    // if(tempCount==0){   //4명이 채워질 때
    //     tempCount=4;    //tempCount 원상복구
    //     tempPageCount++;    // 총 페이지 수 ++
    //     newHtml += '<div class=\"other-videos'+tempPageCount+'\"> </div>';
    //     // 숫자를 붙인 div 태그 추가해주기
    // }else {
    //     tempCount--; 
    // }
    console.log("event !!! ", event)
    // 파람의 유저풀네임 === 엑스트라 유저풀네임
    if(params.userFullName == event.extra.userFullName){
        console.log("내 streamID = ", event.streamid)
        myStreamID = event.streamid;        
    }else{ // <<<<<<<<<<<<<<<<<<
        otherStreamID = event.streamid;
    }
    if (event.stream.isScreen && !event.stream.canvasStream) {
        $('#screen-viewer').get(0).srcObject = event.stream;
        $('#screen-viewer').hide();
    }
    else if (event.extra.roomOwner === true) { // 지금은 params.open으로 구분... 되게되있음 사용안하는 if문
        console.log("check event !!! ", event.mediaElement)
        //var video = document.getElementById('main-video');
        //video.setAttribute('data-streamid', event.streamid);
        //// video.style.display = 'none';
        //if(event.type === 'local') {
        //    video.muted = true;
        //    video.volume = 0;
        //}
        //video.srcObject = event.stream;
        //$('#main-video').show();
        event.mediaElement.controls = false;
        meetingList.push(event);
    // var otherVideos = document.querySelector('#other-videos');
    // otherVideos.appendChild(event.mediaElement);
    } else {
        if(event.mediaElement){
            event.mediaElement.controls = false;
            meetingList.push(event);
        }
    }
    // videoTotal 태그 html 변경
    // var otherVideos = document.querySelector('#other-videos');
    // otherVideos.appendChild(event.mediaElement);
    inWebChange();
    connection.onUserStatusChanged(event); // 유저 이름 업데이트
}

function inWebChange(){
    tempCount = 4;
    var newPageCount = 0;
    newHtml = '<div class=\"other-videos'+0+'\"> </div>';
    for(var i=0; i<meetingList.length; i++){
        if(tempCount==0){
            tempCount=4;
            tempPageCount++;
            newPageCount++;
            newHtml += '<div class=\"other-videos'+newPageCount+'\"> </div>';
        }else tempCount--; 
    }
    console.log("html은????>>>>>>>>>>>>>>>>",newHtml);
    $("#other-videos").html(newHtml);
    
    var j=3;
    var newPageCount = 0;
    for(var i=0; i<meetingList.length; i++){
        var newClassName = '.other-videos'+''+newPageCount+'';
        if(j==0){
            j=3;
            newPageCount++;
        }
        var otherVideos = document.querySelector(newClassName);
        
        // 이름표
        let div = document.createElement('div');
        let p = document.createElement('p');
        div.className = 'media-div'
        p.className = 'user-info-label'
        let temp = "["+meetingList[i].extra.userInfo.user_dept+"] "+meetingList[i].extra.userInfo.user_name +" "+meetingList[i].extra.userInfo.user_grade;
        p.innerHTML = `${temp}`
        div.appendChild(meetingList[i].mediaElement);
        div.appendChild(p);
        otherVideos.appendChild(div);
        j--;
    }
    inWebPaging(totalPeople, dataPerPage, pageCount, currentPage);
}

function inMobile(event) {
    console.log("event !!! ", event)
    // 파람의 유저풀네임 === 엑스트라 유저풀네임
    if(params.userFullName == event.extra.userFullName){
        console.log("내 streamID = ", event.streamid)
        myStreamID = event.streamid;        
    }else{ // <<<<<<<<<<<<<<<<<<
        otherStreamID = event.streamid;
    }


    if (event.stream.isScreen && !event.stream.canvasStream) {
        $('#screen-viewer').get(0).srcObject = event.stream;
        $('#screen-viewer').hide();
    }
    else if (event.extra.roomOwner === true) { // 지금은 params.open으로 구분... 되게되있음 사용안하는 if문
        console.log("check event !!! ", event.mediaElement)
        event.mediaElement.controls = false;
        meetingList.push(event);
        // var otherVideos = document.querySelector('#other-videos');
        // otherVideos.appendChild(event.mediaElement);
        } else {
            if(event.mediaElement){
                event.mediaElement.controls = false;
                meetingList.push(event);
        }
    }
    inMobileChange();
    connection.onUserStatusChanged(event); // 유저 이름 업데이트
}

function inMobileChange(){
    console.log("meetingList.length>>>>>>>>>>?",meetingList.length);
    tempCount=2;
    var newPageCount = 0;
    newHtml = '<div class=\"other-videos'+0+'\"> </div>';
    for(var i=0; i<meetingList.length; i++){
        if(tempCount==0){   //4명이 채워질 때
            tempCount=1;    //tempCount 원상복구
            tempPageCount++;    // 총 페이지 수 ++
            newPageCount++;
            newHtml += '<div class=\"other-videos'+newPageCount+'\"> </div>';
            // 숫자를 붙인 div 태그 추가해주기
        }else {
            tempCount--;
        }
    }

    // videoTotal 태그 html 변경
    $("#other-videos").html(newHtml);

    // 추가된 div태그에 video 태그 4개씩 넣기
    var j=2;
    var newPageCount = 0;
    for(var i=0; i<meetingList.length; i++){
        if(j==0){
            j=2;
            newPageCount++;
        }
        var newClassName = '.other-videos'+''+newPageCount+'';
        var otherVideos = document.querySelector(newClassName);
        console.log("j>>>",j,"newClassName>>>",newClassName);
         // 이름표
        let div = document.createElement('div');
        let p = document.createElement('p');
        div.className = 'media-div'
        p.className = 'user-info-label'
        let temp = "["+meetingList[i].extra.userInfo.user_dept+"] "+meetingList[i].extra.userInfo.user_name +" "+meetingList[i].extra.userInfo.user_grade;
        p.innerHTML = `${temp}`
        div.appendChild(meetingList[i].mediaElement);
        div.appendChild(p);
        otherVideos.appendChild(div);  
           j--;  
          }
    inMobilePaging(totalPeople, dataPerPage, pageCount, currentPage);
}

// 페이지 넘기든 버튼 클릭 시
function clickPage(flag){
    if(flag=='next'){
    currentPage+=1;
    }else{
    currentPage-=1;
}

    if($(window).width() >768) {
        inWebPaging(totalPeople, dataPerPage, pageCount, currentPage);
    }else
        inMobilePaging(totalPeople, dataPerPage, pageCount, currentPage);
}



// 페이징
function inWebPaging(totalPeople, dataPerPage, pageCount, currentPage){
    
    var totalPage = Math.ceil(totalPeople/dataPerPage);    // 총 페이지 수
    console.log("totalPage>>>>>>>>>>>>>",totalPage);
    var pageGroup = Math.ceil(currentPage/pageCount);    // 페이지 그룹

    var htmlNext = "";
    var htmlPrev = "";
    var next = currentPage+1;
    var prev = currentPage-1;

    var $pingingView = $("#paging");
    
    console.log("prev>>>>>>>>>>>>>>",prev);

    if(prev > 0){
      console.log("prev가 0보다 크다!!!")
      htmlPrev += "<img id='prev' src='../img/prev.png' alt='이전' onclick='clickPage(\"prev\")'/>";
    //   "<button onclick='clickPage(\"prev\")' id='"+prev+"'><</button>"
    }else{
        htmlPrev += "<img id='prev' src='../img/prev_gray.png' alt='이전'/>";
    }
    
    // html += "<a href='#' id=" + currentPage + ">" + currentPage + "</a> ";

    if(currentPage < totalPage){
      console.log("현재 페이지가 토탈보다 작다 !!!");
      htmlNext += "<img id='next' src='../img/next.png' alt='다음' onclick='clickPage(\"next\")'/>";
    //   htmlNext += "<button onclick='clickPage(\"next\")' id='"+next+"'>></button>";
    }else{
    htmlNext += "<img id='next' src='../img/next_gray.png' alt='다음'>";
    }
        
    $("#paging-prev").html(htmlPrev);    // 페이지 목록 생성
    $("#paging-next").html(htmlNext);    // 페이지 목록 생성

    $("#paging-prev").css("visibility", "visible");
    $("#paging-next").css("visibility", "visible");

    // $("#paging a").css("color", "black");
    // $("#paging a#" + currentPage).css({"text-decoration":"none", 
    //                                        "color":"red", 
    //                                        "font-weight":"bold"});    // 현재 페이지 표시

    for(var i=1; i<=(meetingList.length/4)+1; i++){
      var className = '.other-videos'+''+(i-1)+'';
      console.log('className???',className);
      if(i == currentPage){
        console.log(currentPage,"   추가하세용");
        $(className).css("display","block");
      }else{
        console.log(currentPage,"   삭제하세용");
        $(className).css("display","none");
    }
}

$("#paging a").click(function(){
            
    var $item = $(this);
    var $id = $item.attr("id");
    var selectedPage = $item.text();
            
    if($id == "next")    selectedPage = next;
    if($id == "prev")    selectedPage = prev;
            
    paging(totalPeople, dataPerPage, pageCount, selectedPage);
});
                                           
}

function inMobilePaging(totalPeople, dataPerPage, pageCount, currentPage){
    
    var totalPage = Math.ceil(totalPeople/dataPerPage);    // 총 페이지 수
    console.log("totalPage>>>>>>>>>>>>>",totalPage);
    var pageGroup = Math.ceil(currentPage/pageCount);    // 페이지 그룹

    var htmlNext = "";
    var htmlPrev = "";
    var next = currentPage+1;
    var prev = currentPage-1;

    var $pingingView = $("#paging");
    
    console.log("prev>>>>>>>>>>>>>>",prev);

    if(prev > 0){
      console.log("prev가 0보다 크다!!!")
      htmlPrev += "<img id='prev' src='../img/prev.png' alt='이전' onclick='clickPage(\"prev\")'/>";
    //   "<button onclick='clickPage(\"prev\")' id='"+prev+"'><</button>"
    }else{
        htmlPrev += "<img id='prev' src='../img/prev_gray.png' alt='이전'/>";
    }
    
    // html += "<a href='#' id=" + currentPage + ">" + currentPage + "</a> ";
    
    console.log("currentPage??>>>>",currentPage,"totalPage>>>>",totalPage, "totalPeople>>>>", totalPeople);
    if(currentPage < totalPage){
      console.log("현재 페이지가 토탈보다 작다 !!!");
      htmlNext += "<img id='next' src='../img/next.png' alt='다음' onclick='clickPage(\"next\")'/>";
    //   htmlNext += "<button onclick='clickPage(\"next\")' id='"+next+"'>></button>";
    }else{
    htmlNext += "<img id='next' src='../img/next_gray.png' alt='다음'>";
    }
        
    $("#paging-prev").html(htmlPrev);    // 페이지 목록 생성
    $("#paging-next").html(htmlNext);    // 페이지 목록 생성

    $("#paging-prev").css("visibility", "visible");
    $("#paging-next").css("visibility", "visible");

    // $("#paging a").css("color", "black");
    // $("#paging a#" + currentPage).css({"text-decoration":"none", 
    //                                        "color":"red", 
    //                                        "font-weight":"bold"});    // 현재 페이지 표시
    console.log("meetingList.length>>>",meetingList.length)
    for(var i=1; i<=(meetingList.length/2)+1; i++){
      var className = '.other-videos'+''+(i-1)+'';
      console.log('className???',className);
      if(i == currentPage){
        console.log(currentPage,"   추가하세용");
        $(className).css("display","block");
      }else{
        console.log(currentPage,"   삭제하세용");
        $(className).css("display","none");
    }
}

$("#paging a").click(function(){
            
    var $item = $(this);
    var $id = $item.attr("id");
    var selectedPage = $item.text();
            
    if($id == "next")    selectedPage = next;
    if($id == "prev")    selectedPage = prev;
            
    paging(totalPeople, dataPerPage, pageCount, selectedPage);
});
                                           
}

connection.onstreamended = function(event) {
    for(var i=0; i<=meetingList.length; i++){
        if(event == meetingList[i]){
            meetingList.splice(i,1);
            totalPeople --;
        }
    } 
    if($(window).width() >768) {
        inWebChange();
    }else{
        inMobileChange();
    }
    
    // 사람 나갈 때 화면 다시 정렬
    console.log("btn_memo_flag",btn_memo_flag);
    console.log("isShareVideo",isShareVideo);
    console.log("isMediaSharing",isMediaSharing);
    if(btn_memo_flag || isShareVideo || isMediaSharing){
        $("#captiondiv").css("display","none");
        $(".media-div").addClass("on");
        $(".user-info-label").addClass("on");
        $("#other-videos").addClass("on");
        $(".paging-button").addClass("on");
    }
    // console.log
};

var conversationPanel = document.getElementById('conversation-panel');

function appendChatMessage(event, checkmark_id) {
    //console.log("append chatmessage")
    //console.log("message check!!!! ", event)
    var div = document.createElement('div');

    div.className = 'message';

    if (event.data) {
        div.className = 'message you';
        div.innerHTML = '<img src="../img/you1.png" class="sendmark"> <b>[ ' + (`${event.extra.userInfo.user_name}(${event.extra.userInfo.user_dept})` || event.userid) + ' ] </b><div class="chat-contents">' + event.data.chatMessage + '</div>';

        if (event.data.checkmark_id) {
            connection.send({
                checkmark: 'received',
                checkmark_id: event.data.checkmark_id
            });
        }
    } else {
        div.className = 'message me';
        div.innerHTML = '<img class="checkmark" id="' + checkmark_id + '" title="Received" src="../img/me1.png"><b>[ ' + (`${connection.extra.userInfo.user_name}(${connection.extra.userInfo.user_dept})` || event.userid) + ' ] </b><div class="chat-contents">' + event + '</div>';
        // div.style.background = 'rgb(176 136 158)';
        div.style.background = 'rgb(126, 136, 179)';
        
    }

    conversationPanel.prepend(div);

    // conversationPanel.scrollTop = conversationPanel.clientHeight;
    // conversationPanel.scrollTop = conversationPanel.scrollHeight - conversationPanel.scrollTop;
}

var keyPressTimer;
var numberOfKeys = 0;


window.onkeyup = function(e) {
    var code = e.keyCode || e.which;
    if (code == 13) {
        $('#btn-chat-message').click();
    }
};

document.getElementById('btn-chat-message').onclick = function() {
    //console.log("CLICK!!!")
    //var chatMessage = $('.emojionearea-editor').html();
    var chatMessage = $('#txt-chat-message').val();
    $('#txt-chat-message').val("")
    //console.log(chatMessage)
    $('.emojionearea-editor').html('');
    
    if (!chatMessage || !chatMessage.replace(/ /g, '').length) return;

    var checkmark_id = connection.userid + connection.token();

    appendChatMessage(chatMessage, checkmark_id);

    connection.send({
        chatMessage: chatMessage,
        checkmark_id: checkmark_id,
    });

    connection.send({
        typing: false
    });
};

var recentFile;
document.getElementById('btn-attach-file').onclick = function() {
    var file = new FileSelector();
    file.selectSingleFile(function(file) {
        recentFile = file;

        if(connection.getAllParticipants().length >= 1) {
            recentFile.userIndex = 0;
            connection.send(file, connection.getAllParticipants()[recentFile.userIndex]);
        }
    });
};

function getFileHTML(file) {
    var url = file.url || URL.createObjectURL(file);
    var attachment = '<a href="' + url + '" target="_blank" download="' + file.name + '">다운로드: <b>' + file.name + '</b></a>';
    if (file.name.match(/\.jpg|\.png|\.jpeg|\.gif/gi)) {
        attachment += '<br><img crossOrigin="anonymous" src="' + url + '">';
    } else if (file.name.match(/\.wav|\.mp3/gi)) {
        attachment += '<br><audio src="' + url + '" controls></audio>';
    } else if (file.name.match(/\.pdf|\.js|\.txt|\.sh/gi)) {
        attachment += '<iframe class="inline-iframe" src="' + url + '"></iframe></a>';
    }
    return attachment;
}
function getUserInfo(userid){
    var userInfo = userid
    if (connection.peers[userid] && connection.peers[userid].extra.userInfo) {
        userInfo = connection.peers[userid].extra.userInfo;
        console.log("getUSERInfo By userNumber : ",connection.peers[userid].extra.userInfo);
    }
    return userInfo;
}
function getFullName(userid) {
    var _userFullName = userid;
    if (connection.peers[userid] && connection.peers[userid].extra.userFullName) {
        //console.log("FILE getFULLNAME CHECK ! ", connection.peers[userid])
        _userFullName = ` ${connection.peers[userid].extra.userInfo.user_name}(${connection.peers[userid].extra.userInfo.user_dept}) ` || connection.peers[userid].userid;
    }
    return _userFullName;
}

connection.onFileEnd = function(file) {
    var html = getFileHTML(file);
    //console.log("FILE CHECK",file)
    var div = progressHelper[file.uuid].div;
    console.log("file END !!!! " ,fileSendCnt)
    if (file.userid === connection.userid) {
        //if(fileSendCnt == 1){
        div.className = 'message me';
        div.innerHTML =  `<img src="../img/me1.png" class="sendmark"><b>[ ${connection.extra.userInfo.user_name}(${connection.extra.userInfo.user_dept} ] </b><br>` + html;
        div.style.background = 'rgb(126, 136, 179)';
        //}

        if(recentFile) {
            recentFile.userIndex++;
            var nextUserId = connection.getAllParticipants()[recentFile.userIndex];
            if(nextUserId) {
                connection.send(recentFile, nextUserId);
            }
            else {
                recentFile = null;
            }
        }
        else {
            recentFile = null;
        }
    } else {
        div.className = 'message you';
        div.innerHTML = '<img src="../img/you1.png" class="sendmark"> <b>[' + getFullName(file.userid) + ']:</b><br>' + html;
    }
};

// to make sure file-saver dialog is not invoked.
connection.autoSaveToDisk = false;

var progressHelper = {};
let fileSendCnt = 0;
let fileuuid_now;
let fileuuid_prv;

connection.onFileProgress = function(chunk, uuid) {
    var helper = progressHelper[chunk.uuid];
    helper.progress.value = chunk.currentPosition || chunk.maxChunks || helper.progress.max;
    updateLabel(helper.progress, helper.label);
};

connection.onFileStart = function(file) {
    fileuuid_now = file.uuid;
    if(fileuuid_now == fileuuid_prv){
        fileSendCnt ++;
    }else{
        fileSendCnt = 1;
        fileuuid_prv = fileuuid_now;
    }
    var div = document.createElement('div');
    div.className = 'message';

    if (file.userid === connection.userid) {
        var userFullName = file.remoteUserId;
        if(connection.peersBackup[file.remoteUserId]) {
            userFullName = connection.peersBackup[file.remoteUserId].extra.userFullName;
            //console.log("final FILE CHECK !!! ", connection.peersBackup[file.remoteUserId]) // 프로그래스바 to 수정할건지
        }

        div.innerHTML = '<b>You (to: ' + userFullName + '):</b><br><label>0%</label> <progress></progress>';
        div.style.background = 'rgb(16 23 66)';
    } else {
        div.innerHTML = '<b>' + getFullName(file.userid) + ':</b><br><label>0%</label> <progress></progress>';
    }

    div.title = file.name;
    conversationPanel.prepend(div);
    progressHelper[file.uuid] = {
        div: div,
        progress: div.querySelector('progress'),
        label: div.querySelector('label')
    };
    progressHelper[file.uuid].progress.max = file.maxChunks;

    // conversationPanel.scrollTop = conversationPanel.clientHeight;
    // conversationPanel.scrollTop = conversationPanel.scrollHeight - conversationPanel.scrollTop;
};

function updateLabel(progress, label) {
    if (progress.position == -1) return;
    var position = +progress.position.toFixed(2).split('.')[1] || 100;
    label.innerHTML = position + '%';
}

if(!!params.password) {
    connection.password = params.password;
}
designer.appendTo(document.getElementById('widget-container'), function() {
    if(DetectRTC.isMobileDevice){
        //alert("모바일!")
        document.querySelector('#mobile-device-box').style.display = 'block';
        videoSelect.onchange = changeCamera;
        $('#main-audio').css({
            width: "calc(80%)",
            bottom: "200px",
        });
        //   
    }else{
        //console.log("DetectRTC ,", DetectRTC)
        //alert("DESK TOP!")
    }


    if (params.open === true || params.open === 'true') {
        //console.log("개설자");
        init_btn_sync = true;
        init_share_media = true;
        // connection.extra.manager=true;
        // console.log("이사람이 바로 매니저요");
        // console.log(connection.extra.userInfo);
        // console.log(event.extra.manager);
        connection.open(params.sessionid, function(isRoomOpened, roomid, error) {
            if (error) {
                if (error === connection.errors.ROOM_NOT_AVAILABLE) {
                    swal('Someone already created this room. Please either join or create a separate room.');
                    return;
                }
                swal(error);
            }

            connection.socket.on('disconnect', function() {
                location.reload();
            });
        });
    } else {
        //console.log("참가자");
        connection.join(params.sessionid, function(isRoomJoined, roomid, error) {
            if (error) {
                if (error === connection.errors.ROOM_NOT_AVAILABLE) {
                    swal('This room does not exist. Please either create it or wait for moderator to enter in the room.');
                    return;
                }
                if (error === connection.errors.ROOM_FULL) {
                    swal('Room is full.');
                    return;
                }
                if (error === connection.errors.INVALID_PASSWORD) {
                    connection.password = prompt('Please enter room password.') || '';
                    if(!connection.password.length) {
                        swal('Invalid password.');
                        return;
                    }
                    connection.join(params.sessionid, function(isRoomJoined, roomid, error) {
                        if(error) {
                            swal(error);
                        }
                    });
                    return;
                }
                swal(error);
            }
            initBtnClock();
            connection.socket.on('disconnect', function() {
                location.reload();
            });
        });
    }


    document.getElementById('isMemo').style.display = 'none';
});
function initBtnClock(){
    if(!init_btn_sync || init_share_media){
        connection.send({
            request: 'plz-btn-sync',
            join_id: connection.extra.userFullName
        });// 내아이디 첨부해서 보냄
        //("방 초기 정보점...")
        let timerId = setTimeout(initBtnClock, 2000);
    }
}
function addStreamStopListener(stream, callback) {
    stream.addEventListener('ended', function() {
        callback();
        callback = function() {};
    }, false);

    stream.addEventListener('inactive', function() {
        callback();
        callback = function() {};
    }, false);

    stream.getTracks().forEach(function(track) {
        track.addEventListener('ended', function() {
            callback();
            callback = function() {};
        }, false);

        track.addEventListener('inactive', function() {
            callback();
            callback = function() {};
        }, false);
    });
}
function replaceTrack(videoTrack, screenTrackId) {
    if (!videoTrack) return;
    if (videoTrack.readyState === 'ended') {
        swal('Can not replace an "ended" track. track.readyState: ' + videoTrack.readyState);
        return;
    }
    connection.getAllParticipants().forEach(function(pid) {
        console.log("PID ", pid)
        var peer = connection.peers[pid].peer;
        if (!peer.getSenders) return;
        var trackToReplace = videoTrack;
        peer.getSenders().forEach(function(sender) {
            console.log("sender ! ", sender)
            if (!sender || !sender.track) return;
            if(screenTrackId) {
                if(trackToReplace && sender.track.id === screenTrackId) {
                    sender.replaceTrack(trackToReplace);
                    trackToReplace = null;
                }
                return;
            }
            if (sender.track.kind === 'video' && trackToReplace) {
                sender.replaceTrack(trackToReplace);
                console.log("peer replaceTrack excute!!! ")
                trackToReplace = null;
            }
        });
    });
}

function replaceScreenTrack(stream) {
    stream.isScreen = true;
    stream.streamid = stream.id;
    stream.type = 'local';

    // connection.attachStreams.push(stream);
    connection.onstream({
        stream: stream,
        type: 'local',
        streamid: stream.id,
        // mediaElement: video
    });

    var screenTrackId = stream.getTracks()[0].id;
    addStreamStopListener(stream, function() {
        connection.send({
            hideMainVideo: true
        });

        // $('#main-video').hide();
        $('#screen-viewer').hide();
        //$('#btn-share-screen').show();
        replaceTrack(tempStream.getTracks()[0], screenTrackId);
    });

    stream.getTracks().forEach(function(track) {
        if(track.kind === 'video' && track.readyState === 'live') {
            replaceTrack(track);
        }
    });

    connection.send({
        showMainVideo: true
    });

    // $('#main-video').show();
    $('#screen-viewer').css({
            top: $('#widget-container').offset().top,
            left: $('#widget-container').offset().left,
            width: $('#widget-container').width(),
            height: $('#widget-container').height()
        });
    $('#screen-viewer').show();
}

// 카메라 목록 테스트

const videoSelect = document.querySelector('select#videoSource');

function handleError(error) {
  console.log('navigator.MediaDevices.getUserMedia error: ', error.message, error.name);
}

function gotDevices(deviceInfos){
      // Handles being called several times to update labels. Preserve values.
  const selectors = [videoSelect];
  const values = selectors.map(select => select.value);
  selectors.forEach(select => {
    while (select.firstChild) {
      select.removeChild(select.firstChild);
    }
  });
  for (let i = 0; i !== deviceInfos.length; ++i) {
    const cameras = $("#camera-selector");
    const deviceInfo = deviceInfos[i];
    const option = document.createElement('option');
    option.value = deviceInfo.deviceId;
     if (deviceInfo.kind === 'videoinput') {
      option.text = deviceInfo.label || `camera ${videoSelect.length + 1}`;
      videoSelect.appendChild(option);
     } else {
       console.log('Some other kind of source/device: ', deviceInfo);
     }
  }
  selectors.forEach((select, selectorIndex) => {
    if (Array.prototype.slice.call(select.childNodes).some(n => n.value === values[selectorIndex])) {
      select.value = values[selectorIndex];
    }
  });
}

function gotStream(stream) {
  const videoElement = document.querySelector('video');
  window.stream = stream; // make stream available to console
  videoElement.srcObject = stream;
  // Refresh button list in case labels have become available
  return navigator.mediaDevices.enumerateDevices();
}
function changeCamera() {
    $("input:checkbox[id='select-mobile-cam']").prop("checked", false);
    const videoSource = videoSelect.value;
    navigator.mediaDevices
  .getUserMedia({
    video:{deviceId: videoSource ? {exact: videoSource} : undefined}
  })
  .then(function(stream) {
      let videoTrack = stream.getVideoTracks()[0];
      let myVideo = document.getElementById(myStreamID);
      
      for(let i=0;i<meetingList.length;i++){
          if(meetingList[i].streamid == myStreamID){
            myVideo.srcObject = null;
            let newStream = meetingList[i].stream;
            newStream.removeTrack(newStream.getVideoTracks()[0]);
            newStream.addTrack(stream.getVideoTracks()[0]);
            meetingList[i].stream = null;
            meetingList[i].stream = newStream;
            myVideo.srcObject = newStream;
            console.log("myVideo Track2", myVideo.srcObject.getVideoTracks()[0])
            
            //myVideo.srcObject = null;
            //myVideo.srcObject = newStream;
          

            break;
          }
      }
      //let myVideo = document.getElementById(myStreamID);
      //let myVideoStream = myVideo.srcObject;
      //myVideo.srcObject.addTrack(videoTrack);
      //myVideoStream.removeTrack(myVideo.srcObject.getVideoTracks()[0])
      //myVideoStream.addTrack(videoTrack)
      //myVideo.srcObject = null;
      //myVideo.srcObject = myVideoStream;
      replaceTrack(videoTrack, false);
  })
  .catch(function(err) {
    console.error('Error happens:', err);
  });

//   if (window.stream) {
//     window.stream.getTracks().forEach(track => {
//       track.stop();
//     });
//   }
  
//   const constraints = {
//     video: {deviceId: videoSource ? {exact: videoSource} : undefined}
//   };
//   navigator.mediaDevices.getUserMedia(constraints).then(gotStream).then(gotDevices).catch(handleError);
}


////////////////

//    button func
//    button func
// 초대하기
//  let copyBtn=document.getElementsByClassName("invitelink");

// copyBtn.addEventListener("click",function(){
//     let text="https://k3d106.p.ssafy.io/meeting/"
//     let createInput=document.createElement("input");
//     createInput.setAttribute("type","text");
//     document.getElementById("invitelink").appendChild(createInput);
//     createInput.value=text;
//     createInput.select();
//     document.execCommand('copy');
//     document.getElementById("invitelink").removeChild(createInput)
//     alert('초대 링크 복사 완료');
// })
$(".invitelink i").click(function (e) {
    let manager=connection.streamEvents.selectAll()[1].extra.userInfo.user_name;
    console.log(connection.streamEvents.selectAll()[1].extra.userInfo.user_name);
    let text="https://k3d106.p.ssafy.io/meeting/"+manager;
    let createInput=document.createElement("input");
    createInput.setAttribute("type","text");
    document.getElementById("invitelink").appendChild(createInput);
    createInput.value=text;
    createInput.select();
    document.execCommand('copy');
    document.getElementById("invitelink").removeChild(createInput);
    swal("COPY LINK", "초대 링크가 복사되었습니다.", "success");
});
// 캠 끄기
$("#onoff-cam i").click(function (e) {
    camactiveis = $("#onoff-cam i").hasClass("active");
    //active: 동작중
    var streamByUserId = connection.streamEvents.selectFirst({
        userid: connection.userid,
    }).stream;
    if (camactiveis) {
        streamByUserId.mute("video");
        $(this).removeClass("active");
    } else {
        streamByUserId.unmute("video");
        $(this).addClass("active");
    }
});
// 마이크 끄기
$("#onoff-mic i").click(function () {
    micactiveis = $("#onoff-mic i").hasClass("active");
    var streamByUserId = connection.streamEvents.selectFirst({
        userid: connection.userid,
    }).stream;
    if (micactiveis) {
        streamByUserId.mute("audio");
        recognition.stop();
        $(this).removeClass("active");
    } else {
        streamByUserId.unmute("audio");
        recognition.start();
        $(this).addClass("active");
    }
    // $(this).toggleClass("active");
    // alert("onoff-mic");
});
$("#onoff-caption i").click(function () {
    $(this).toggleClass("active");

    captionactiveis = $("#captiondiv").hasClass("activecaption");

    if (captionactiveis) {
        $("#captiondiv").removeClass("activecaption");
    }
    if (!captionactiveis) {
        $("#captiondiv").addClass("activecaption");
    }
});
$("#onoff-data i").click(function () {
    menuactiveis = $("#onoff-data i").hasClass("active");
    if (!menuactiveis) {
        onsignvideo();
    }
    if (menuactiveis) {
        offsignvideo();
    }

    swal("onoff-data");
});
//참여자 sidebar 클릭시
$("#participant-label").click(function () {
    // onsaveboxmenu();
    participantactiveis = $("#participantboxact").hasClass("active");
    chatactiveis = $("#chatboxact").hasClass("active");
    saveactiveis = $("#saveboxact").hasClass("active");
    if (participantactiveis) {
        $("#participantboxact").removeClass("active");
        $("#participant-boxid").removeClass("active");
    }
    if (!chatactiveis) {
        $("#chatboxact").addClass("active");
        $("#chat-boxid").addClass("active");
    }
    if (!saveactiveis) {
        $("#saveboxact").addClass("active");
        $("#save-boxid").addClass("active");
    }
});
// 채팅 sidebar 클릭시
$("#chat-label").click(function () {
    //console.log("chat!!!!");
    // offsaveboxmenu();
    participantactiveis = $("#participantboxact").hasClass("active");
    chatactiveis = $("#chatboxact").hasClass("active");
    saveactiveis = $("#saveboxact").hasClass("active");
    if (!participantactiveis) {
        $("#participantboxact").addClass("active");
        $("#participant-boxid").addClass("active");
    }
    if (chatactiveis) {
        $("#chatboxact").removeClass("active");
        $("#chat-boxid").removeClass("active");
    }
    if (!saveactiveis) {
        $("#saveboxact").addClass("active");
        $("#save-boxid").addClass("active");
    }
});
// 보관함 sidebar 클릭시
$("#save-label").click(function () {
    // onsaveboxmenu();
    participantactiveis = $("#participantboxact").hasClass("active");
    chatactiveis = $("#chatboxact").hasClass("active");
    saveactiveis = $("#saveboxact").hasClass("active");
    if (!participantactiveis) {
        $("#participantboxact").addClass("active");
        $("#participant-boxid").addClass("active");
    }
    if (!chatactiveis) {
        $("#chatboxact").addClass("active");
        $("#chat-boxid").addClass("active");
    }
    if (saveactiveis) {
        $("#saveboxact").removeClass("active");
        $("#save-boxid").removeClass("active");
    }
    selectAllMedia();
});

</script>
</body>
<style type="text/css">
    .chat-contents{
        padding-left: 40px;
    }
    #mobile-device-box{
        display: none;
    }
    .rec_class{
        width : 25px;
        height: 25px;
    }
    /* @font-face {
        font-family: "123rf";
        src: url("../font/123RF.otf");
        }
    @font-face {
    font-family: "Binggrae-Bold";
    src: url("../font/Binggrae-Bold.otf");
    }
    @font-face {
    font-family: "Binggrae";
    src: url("../font/Binggrae.otf");
    }
    @font-face {
    font-family: "Binggrae2-Bold";
    src: url("../font/Binggrae2-Bold.otf");
    }
    @font-face {
    font-family: "Binggrae2";
    src: url("../font/Binggrae2.otf");
    } */
    @font-face {
    font-family: "JSDongkang-Bold";
    src: url("../font/JSDongkang-Bold.otf");
    }
    @font-face {
    font-family: "JSDongkang-Regular";
    src: url("../font/JSDongkang-Regular.otf");
    }
    @font-face {
    font-family: "Fredoka One";
    src: url("../font/FredokaOne-Regular.ttf");
    }
    /* logo */
    div .logo{
        cursor: pointer;
        position: fixed;
        top:1%;
        left:1%;
    }

    .logo a{ 
        text-decoration:none ;
        font-size: 25px;
        font-family: "Fredoka One";
        color: rgb(147 166 253);
    }

    #other-videos {
        float:left;
        width: 78%;
        margin-top: 5px;
    }
  /*    6명일때
        /* width: 31%;
        margin: 5px;
        border: 1px solid black;
        padding: 1px;
        border-radius: 3px; */

    #other-videos > div {
        width: 100%;
        height: 100%;
        margin-right:0;
    }
    .media-div{
        float: left;
        width: 48%;
        height: 245px;
        margin-left: 2%;
        margin-bottom: 5%;
        /* border: 1px solid black; */
        padding: 1px;
        border-radius: 3px;
    }
    .media-div  video{
        width: 100%;
        height: 100%;
        margin-left: 3%;
        margin-bottom: 1%;
        /* border: 1px solid black; */
        /* padding: 1px; */
        border-radius: 3px;
    }
    .media-div p {
        margin-left: 8%;
        width: 90%;
        height: 7%;
        text-align: center;
        /* border: 1px solid black; */     
        left:50%;
        /* transform: translateX(-50%); */
    }
    
    /* 화면 공유시 */
    #other-videos.on{
        margin-top: 4%;
        margin-left: 2%;
        padding-left: 6%;
    }
    .media-div.on{
        margin-left: 1%;
        margin-right: 1%;
        margin-bottom: 0;
        width: 20%;
        height: 140px;
    }

   
    .user-info-label.on{
        font-size: 0.8rem;
        margin-bottom: 0;
    }
    .paging-button.on{
        padding-top: 8%;
        width: 9%;
        margin-right: 1%;
    }
    #uploaded-container{
        height: calc(100%);
        overflow-y: hidden;
        overflow-x: hidden;
        margin-right: 20px;
        margin-left: 10px;
        border-top: 2px solid #a9b2e6;
        margin-top: 2%;
    }
    #uploaded-list {
        text-align: left;
        max-height: 90%;
        overflow-x: hidden;
        overflow-y: scroll;
        /* border-top: 2px solid #a9b2e6; */
        width: 110%;
        font-size: 15px;
        margin-left: 2%;
        text-align: center;

    }
    #uploaded-container-header{
        margin-top: 3%;
        display:flex;
        justify-content: space-between;
        align-items: center;
        text-align: center;
    }
    #savebox-header{
        margin:0;
        margin-left:20px;
    }
    #savebox-header-day{
        margin:0;
        margin-right:50px;
    }
    #saveboxact{
      margin-left: 2px;
      background:#101742;
      width: 100%;
      left: 20px;
      height: 100%;
      overflow: hidden;
    }
    .media-element{
        cursor: pointer;
    }

    /* containerA */
    #containerA{
        background: rgb(0, 0, 0);
        width: calc(100% - 300px);
        height: calc(100% - 120px);
        position: absolute; 
        left: 0;
    }
    
    /* caption */

    #containerA div.activecaption {
      display: none;
    }
    /*widget-container  */
    #widget-container {
        position: fixed;
        bottom: 85px;
        /* left: 150px; */
        left: 20%;
        right: 20%;
        height: 400px;
        width: 558px;
        /* width:  calc(60%); */
        border: 1px solid black;
        border-top:0;
        border-bottom: 0;
    }
    
    /* chat */
    .onUserStatusChanged {
      padding: 5px 10px;
      height: 100px;
      background: #252424;
    }

    #btn-chat-message {
        padding-left: 3px;
    }
    .btn-primary {
      background-color: #42025d66;
      border-color: #42025d66;
    }
    .btn-primary:disabled {
      background-color: #42025d66;
      border-color: #42025d66;
    }
    /* side menu */

    #chat-boxid {
        height: calc(100%);
        /* padding: 0 15px; */
    }
    #save-boxid{
        height: calc(100%);
        /* padding: 0 15px; */
    }
    #chatboxact {
      
      /* position: absolute; */
      /* bottom: 0; */
      /* flex-direction: column; */
      
      margin-left: 2px;
      background: #101742;
      width: 100%;
      left: 20px;
      height: calc(100%);
      overflow: hidden;
    }
    #chat-send{
        margin: 3%;
        display:flex;
    }
    #chat-boxid div.active {
      display: none;
    }
    #save-boxid div.active {
      display: none;
    }
    #participant-boxid div.active {
      display: none;
    }
    /* savebox css */
    .table{
        height:100%
    }
    
    /* button */
    .circle-btn i.active {
      background:rgb(41 58 151);
    }
    .circle-btn i.active .offcam {
      display: none;
    }
    .circle-btn i .oncam {
      display: none;
    }
    .circle-btn i.active .oncam {
      display: inline;
    }
    .circle-btn i.active .offmic {
      display: none;
    }
    .circle-btn i .onmic {
      display: none;
    }
    .circle-btn i.active .onmic {
      display: inline;
    }
    
 
    #sidebar-btn i {
      background: none;
    }
    #sidebar-btn i.active,
    #sidebar-btn i.active:before {
      background: rgb(251, 255, 3);
    }

    #sidebar-btn i.active {
      color: #05681b;
      background: white;
    }

    .changeWidth {
      margin-right: 300px;
      width: calc(100vw - 300px);
    }


   /* html { */
  /* overscroll-behavior-y: none; */
/* } */
/* .body */
/* .voracay{ */
  /* position: absolute; */
  /* top: 0px; */
/*  */
  /* Give them all the available space */
  /* width: 100%; */
  /* height: 100%; */
/*  */
  /* Remove the margins if any */
  /* margin: 0; */
/*  */
  /* Allow them to scroll down the document */
  /* overflow-y: hidden; */
/* } */
/* .body{ */
  /* z-index: 1; */
  /* overscroll-behavior-y: none; */
/* } */
/* .voracay{ */
  /* z-index: 2; */
/* } */
html
    body {
      overscroll-behavior-y: contain;
    }

    .temp-stream-canvas{ 
      touch-action: none;
    }
    
    
    .voracay {
      font-family: "JSDongkang-Regular";
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      overflow-y: hidden;
      position: relative;
      background: rgb(0, 0, 0);
      touch-action: none;
    }
    .meetingroom {
      background: rgb(0, 0, 0);
      height: calc(100% - 80px);
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      color: rgb(255, 255, 255);
      font-size: 20px;
      /* 넘어가면 보이지 않게 */
      overflow: hidden;
    }
    .videoBox {
      padding: 50px;
      height: calc(100%-80px);
      position: relative;
      top: 0%;
    }

    .video {
      display: grid;
      grid-gap: 8px;
      grid-template-columns: repeat(auto-fit, minmax(30%, auto));
      grid-template-rows: repeat(auto-fit, minmax(50%, auto));
      justify-content: center;
      line-height: 100%;
      /* place-items: center; */
      white-space: nowrap;
      /* min-height: 100vh; */
    }
    .video div {
      box-sizing: border-box;
    }
    .video-one {
      padding-bottom: 56.26%;
      background-color: white;
    }
    .captionBox {
      /* margin-bottom: 100px; */
      position: relative;
      top: 0%;
      left: 50%;
      margin: 0 auto;
      transform: translate(-50%, 0%);
      /* background: rgba(107, 83, 136, 0.87); */
      width: 100%;
      /*height: 30px;*/
      /*padding: 5px 20px;*/
      /* 가운데 정렬 */
      margin: 0 auto 50px auto;
    }
    .captionBox p {
      background: rgba(41, 62, 248, 0.87);
      color: white;
      word-wrap: break-word;
      word-break: break-all;
      white-space: pre-line;
      padding: 10px 20px;
      /* width: 50%; */
      /* padding: 5px 20px;  */
      text-align: center;
      font-size: 120%;
      line-height: 30px;
    }

    .sidebar {
      height: calc(100% - 80px);
      width: 300px;
      position: fixed;
      z-index: 1;
      top: 0;
      right: 0;
      background: rgb(0, 0, 0);
      /* opacity: 0.9; */
      overflow: hidden;
    }


    .sidemargin {
      width: (100vw - 300px);
    }
    .sign-box {
      width: 300px;
      height: 200px;
      background: rgb(255, 218, 246);
      z-index: 4;
      position: absolute;
      right: 0;
      bottom: 80px;
      display: none;
    }

    .signVideoWidth {
      display: block;
    }

    .btn-zip {
      font-family: "JSDongkang-Bold";
      display: grid;
      grid-template-columns: 1fr 1fr 1fr ;
      text-align: center;
      justify-content: center;
    }

    .btn-zip > input[type="radio"] {
      opacity: 0;
      position: fixed;
      width: 0;
    }

    .btn-zip label {
      display: inline-block;
      background-color: rgb(169, 178, 230);;
      padding: 10px;
      font-size: 16px;
      /* border: 2px solid #444; */
      border-radius: 10px 10px 0 0;
    }
    .btn-zip input[type="radio"]:checked + label {
      background-image: linear-gradient(
        to right top,
        /* rgb(41, 58, 151),
        rgb(41, 58, 151),
        rgb(35, 49, 128),
        rgb(35, 49, 128),
        rgb(32, 43, 146),
        rgb(30, 36, 122),
        rgb(35, 49, 128),
        rgb(35, 49, 128),
        rgb(52, 41, 151),
        rgb(41, 58, 151) */
        #082257,
        #0d1a41,
        #111742,
        #0b0c41,
        #131755,
        #172d6b,
        rgb(24, 19, 90),
        #110d47,
        #121757,
        #191350,
        #1b1246,
        #160e57
      );
    }

    .btn-zip label:hover {
      cursor: pointer;
      background-color: rgb(100, 115, 197);
    }

    .btn-item {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chat-btn {
      animation: move 1s;
      margin-bottom: 0;
      display:flex;
    }
    .save-btn {
      animation: move 1s;
      margin-bottom: 0;
    }
    .participant-btn {
      animation: move 1s;
      margin-bottom: 0;
    }

    .chosed-box {
      width: 100%;
      height: calc(100% - 50px);
      background: #101742;
    }
    .chosed-box div.active {
      display: none;
    }
    .plus-box {
      width: 100%;
      height: 80px;
      background-image: linear-gradient(
        to right top,
         rgb(179, 184, 255),
        rgb(158, 151, 250),
        rgb(152, 162, 253),
        #a2b0ff,
        #9aa9ff,
        rgb(147, 167, 253),
        #94a4ff 
        /* samsung color */
        /* rgb(41, 58, 151),
        rgb(41, 58, 151),
        rgb(35, 49, 128),
        rgb(35, 49, 128),
        rgb(30, 44, 122),
        rgb(30, 44, 122),
        rgb(35, 49, 128),
        rgb(35, 49, 128),
        rgb(41, 58, 151),
        rgb(41, 58, 151) */
      );
      /*  rgb(179, 184, 255),
        rgb(158, 151, 250),
        rgb(152, 162, 253),
        #a2b0ff,
        #9aa9ff,
        rgb(147, 167, 253),
        #94a4ff */
      z-index: 2;
      position:absolute;
      margin-bottom: 80px;
      left: 0;
    }

    .meeting-bottom {
      width: 100%;
      height: 120px;
      /* padding:20px; */

      position: fixed;
      bottom: 0;
      left: 0;
      z-index: 4;
      overflow: hidden;
      display: flex;
      justify-content: center;
    }

    .bottom-btn-box {
      padding-top: 45px;
      width: 50%;
      height: 100%;
      display: flex;
      justify-content: space-around;
      align-items: center;
    }

    .circle-btn {
      position: relative;
      /* display: block; */
      align-items: center;
      width: 100%;
      /* height: 100%; */
      margin: 15px;
    }
    .arrow_box {
      z-index: 5;
      text-align: center;
      display: none;
      position: absolute;
      width: 120px;
      padding: 8px;
      top: -80%;
      left: -40%;
      -webkit-border-radius: 8px;
      -moz-border-radius: 8px;
      border-radius: 8px;
      background: rgb(12, 2, 68);
      color: #fff;
      font-size: 14px;
      opacity: 0.8;
    }

    .arrow_box:after {
      position: absolute;
      top: 100%;
      left: 50%;
      width: 0;
      height: 0;
      margin-left: -10px;
      border: solid transparent;
      border-color: rgba(51, 51, 51, 0);
      border-top-color: rgb(12, 2, 68);
      border-width: 10px;
      pointer-events: none;
      content: " ";
    }

    /* .circle-btn:hover > p.arrow_box {
      display: block;
    } */
    .circle-btn:hover > p.arrow_box {
      display: block;
    }
    .circle-btn:hover {
      cursor: pointer;
    }
    .circle-btn i:hover {
      cursor: pointer;
      /* samsung color */
      border: 4.5px solid rgb(255, 255, 255);
    }

    .circle-btn i {
      display: block;
      color: white;
      padding: 20px;
      width: 62px;
      height: 62px;
      border-radius: 40%;
      /* samsung color 
      4px solid rgb(163, 168, 233); */
      /* 3px solid rgb(212, 215, 255); */
      border: 3px solid rgb(16, 24, 133);; 
      justify-content: center;
      align-items: center;
      display: flex;
    }

    .hello {
      display: grid;
      grid-template-columns: auto auto auto;
    }




    /* 기존 CSS */
    .extra-controls {
        position: absolute;
        right: 21%;
    }

    
    #other-videos {
        margin-top: 5px;
    }
  /*    6명일때

    #btn-comments {
        color: red;
        margin-top: 5px;
        font-size: 24px;
        text-shadow: 1px 1px white;
    }
        /* width: 31%;
        margin: 5px;
        border: 1px solid black;
        padding: 1px;
        border-radius: 3px; */
        
        
        /*#other-videos video {
        width: 45%;
        height: 250px;
        margin: 10px;
        /* border: 1px solid black; */
        /*padding: 1px;
        border-radius: 3px;
      }*/
    
    #txt-chat-message {
        width: 90%;
        /* resize:none;
        margin: 5px;
        margin-right: 0; */
        overflow-y: scroll;
        height: 35px;
        border-radius: 10px;
    }
    
    #btn-chat-message {
        
        margin-left: 2px;
        height: 35px;
        width: 30px;
        padding: 2px;
        padding-left: 0px;
        padding-right: 0px;
    }
    #chat-container{
        height:  calc(100%);
        overflow-y: hidden;
        overflow-x: hidden;
        margin-right: 10px;
        margin-left: 10px;
        border-top: 2px solid #a9b2e6;
    }
    #conversation-panel {
        /* margin-bottom: 20px; */
        text-align: left;
        /* max-height: 180px; */
        height:  calc(80%);
        overflow-x: hidden;
        overflow-y: scroll;
        /* width:106%; */
        /* 위에로 설정: scroll조금만 보임, 110%로하면 아예안보임 */
        width: 110%;
        font-size: 15px;
        margin-top: 3%;
    }
    
    #conversation-panel .message {
        border-bottom: 2px solid #a9b2e6;
        padding: 2px 10px;
        word-wrap: break-word;
        border-radius: 10px;
        /* margin-left: 2%; */
        /* margin-right: 10%; */
        margin-bottom: 4%;
        /* margin-top: 1%; */
        border: 1px solid rgb(76 78 90);
        box-shadow: 2px 2px 3px #000000;
        background-color: #344386;
    }
    .message{
        overflow: auto;
    }
    .message.you{
        float: right;
        margin-right: 9%;
        margin-left: 10%;
    }

    .message.me{
        margin-right: 7%;
        float: left;
    }
    
    #conversation-panel .message img, #conversation-panel .message video, #conversation-panel .message iframe {
        max-width: 100%;
    }
    
    #main-video {
        display: block;
        width:0px;
        height: 0px;
    }
    #main-img{
        display: none;
    }
    #main-audio{
         width: 100%;
        position: fixed;
        bottom: 85px;
        left:calc( 10% + 1px);
        width:  calc(58%);
      
        margin-top: -9px;
      
        z-index: 3; 

        /* width: 100%;
        position: fixed;
        bottom: 85px;
        left:calc( 10% + 1px);
        width:  calc(100% -50px);
        
        margin-top: -9px;
      
        z-index: 3; */
    }
    hr {
        height: 1px;
        border: 0;
        background: #E5E5E5;
    }
    
    #btn-attach-file {

        vertical-align: middle;
        cursor: pointer;
        display: none;
        display: inline-block;
        padding-left: 3px;
        padding-top: 3px;
        padding-right: 3px;
    }
    
    
    
    .checkmark {
        display:none;
        width: 40px;
        vertical-align: middle;
    }
    .sendmark {
        width: 40px;
        height: 40px;
    }
    
    #screen-viewer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        /* 99999 */
        z-index: 4;
        display: none;
    }
    
    .paging-button{
        float: left;
        width: 10%;
        height: 100%;
        padding-top: 21%;
    }

    #paging-next{
        width:90%;
        height:100%;
    }

    #paging-prev{
        width:90%;
        height:100%;
    }

    #next{
        float:left;
        width: 35px;
        height: 35px;
        margin-right: 70%;
    }

    #prev{
        width: 35px;
        height: 35px;
        margin-left: 80%;
        margin-right: 25%;

    }
    #more, #close{
            display: none;
        }

    .back{
        float: left;
        display: none;
        width: 10%;
        height: 5%;
        margin-top: 5%;
        margin-left: 3%;
    }

    .mobile-title{
        display: none;
    }

    #participant-table{
        text-align: center;
    }

    #participant-table > tbody{
     font-size: 1rem;   
    }

    #participant-table > thead {
        background-color: #55608f;
        border-bottom: 1px solid gray;
    }

    .media-element > td{
        border-bottom: 1px solid #dee2e6;
        border-top: 0px solid #dee2e6;
    }
    /* 추가메뉴  */
    input[id="menuicon"]{
        display: none;
    }  
    .btn-m{
        display:none;
    }
    .plus-menu{
        display:none;
    }
    #select-mobile-cam, #select-mobile, .select-mobile-cam-menu{
        display: none;
    }
    @media screen and (max-width: 768px) {
      
        .media-div.on > p{
        font-size: 1.3rem;
        }
        #widget-container {
            position: fixed;
            bottom: 200px;
            /* left: 150px; */
            left: 25px;
            right: 25px;
            height: 400px;
            width: 558px;
            /* width:  calc(60%); */
            border: 1px solid black;
            border-top:0;
            border-bottom: 0;
        }

        #containerA{
            width: 100%;
        }

        #other-videos{
            width: 80%;
            margin-top: 0;
        }

        #other-videos.on{
            margin-top: 13%;
            margin-left: 0;
            padding-left: 0;
        }

        .paging-button{
            height: 100%;
            width: 10%;
            margin: 0;
            padding: 0;
            padding-top: 68%;
            float:left;
        }

        .paging-button.on{
            height: 100px;
            margin-top: 25%;
        }
        .paging-button.on > div > #prev{
            height: 100%;
        }

        .paging-button.on > div > #next{
            height: 100%;
        }

        .media-div{
            float: left;
            width: 100%;
            height: 360px;
            margin-left: 0%;
            margin-top: 9%;
            /* border: 1px solid black; */
            padding: 1px;
            border-radius: 3px;
        }

        .media-div.on{
            width: 48%;
            height: 200px;
            margin-left: 1%;
        }
        .media-div  video{
            width: 100%;
            height: 100%;
            margin-left: 0;
            margin-bottom: 3%;
            margin-top: 1%;
            /* border: 1px solid black; */
            /* padding: 1px; */
            border-radius: 3px;
        }
        .media-div p {
            margin-left: 5%;
            margin-bottom: 4%;
            width: 90%;
            height: 7%;
            text-align: center;
            font-size : 1.5rem;
            /* border: 1px solid black; */
            left:50%;
            /* transform: translateX(-50%); */
        }
        #prev{
            width: 100%;
            height: 50px;
            margin-left: 20%;
        }
        #next{
            width: 100%;
            height: 50px;
            margin-right: 0;
        }
        
        #sidebar{
            display: none;
        }


        /* mobile sidebar css */
        #sidebar.on{
            display: block;
            width: 100%;
            height: 100%;
        }

        .sidebar.on > .chosed-box > #participant-boxid > #participantboxact > #onUserStatusChanged > #participant-list {
            margin-right: 10%;
            font-size: 1.6rem;
        }

        .sidebar.on > .chosed-box > #participant-boxid{
            margin-left: 10%;
        }   

        #participant-table > tbody{
            font-size: 1.3rem;   
        }

        .mobile-title{
            font-size: 2.2rem;
            margin-left: 3%;
            margin-top: 6%;
            margin-bottom: 5%;
            float:left;
            width: 80%;
        }

        #chat-boxid.on > #chatboxact > #chat-send> #txt-chat-message{
            height: 60px;
            width: 80%;
            font-size: 2rem;
        }

        #chat-boxid.on > #chatboxact > #chat-send> #btn-chat-message{
            width: 8%;
            height: 8%;
            margin: 1%;
        }

        #chat-boxid.on > #chatboxact > #chat-send> #btn-attach-file{
            width: 8%;
            height: 8%;
            margin: 1%;
        }

        #chat-boxid.on > #chatboxact > #chat-container > #conversation-panel> .message{
            font-size: 2rem;
            padding-top: 1.3%;
        }

        #chat-boxid.on > #chatboxact > #chat-container > #conversation-panel> .message >img{
            height: 60px;
            width: 60px;
            padding-bottom: 1%;
        }

        .message.you{
            margin-right: 10%;
            margin-left: 10%;
        }

        .message.me{
            margin-right: 10%;
        }
        
        .meetingroom{
            height: calc(100% - 130px);
        }

        /* logo  */
        div .logo{
        cursor: pointer;
        position: fixed;
        display:flex;
        top:2%;
        left: 33%;
        /* justify-content: space-between;
        align-items: center; */
        }
        #btn-mobile-cam{
            position: fixed;
            top:2%;
            right:7%;
        }

         .logo a{ 
    
        font-size: 35px;
       
        }

        /* MENU */
        /* MENU-아래 메뉴 부분  */
        .meeting-bottom {
            height: 130px;
            border: 0px;
            background-image: linear-gradient(
                to right top,
                rgb(179, 184, 255),
                rgb(158, 151, 250),
                rgb(152, 162, 253),
                #a2b0ff,
                #9aa9ff,
                rgb(147, 167, 253),
                #94a4ff 
                /* samsung color */
                /* rgb(41, 58, 151),
                rgb(41, 58, 151),
                rgb(35, 49, 128),
                rgb(35, 49, 128),
                rgb(30, 44, 122),
                rgb(30, 44, 122),
                rgb(35, 49, 128),
                rgb(35, 49, 128),
                rgb(41, 58, 151),
                rgb(41, 58, 151) */
            );
        }
        .sidebar-first,.sidebar-second,.sidebar-third{
            display:flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
           
        }
        .sidebar-first{
            margin-top: 30px;
        }
        .sidebar-i{
            margin-left: 20px;
        }
        .btn-m{
            text-align: -webkit-center;
            margin:0;
        }
        .btn-label{
            margin-top: 10px;
            font-family: "JSDongkang-Bold";
            font-size: 23px;
        }
        
        /* MENU-색  */
        .plus-box {
            height: 130px;
            border: 0px;
        }
        #select-mobile, .select-mobile-cam-menu{
            display:inline;
        }
        
        .select-mobile-cam-menu .hiddenbar{
            position: fixed;
            top: 40%;
            left:100%;
            width: 50%;
            bottom:40%;
            background-color: rgb(147, 167, 253);
            /* background-image: linear-gradient(
                to bottom ,
                rgb(30, 44, 122),
                rgb(147, 167, 253)
            ); */
            transition: .35s; 
            border-radius: 20%;
            border: 5px solid  rgb(30, 44, 122);
            z-index: 999999;

        }
        #mobile-device-box{
            padding-top: 40px;
            text-align-last: center;
            text-align: -webkit-center;
            
        }
        #mobile-device-box-label{
            font-family: "JSDongkang-Bold";
            font-size: 30px;
            color:  rgb(41 58 151);
        }
        input[id=select-mobile-cam]:checked ~ .containerB .select-mobile-cam-menu .hiddenbar{
            left:25%;
        }
        /* 추가메뉴  */
        .plus-menu{
        display:inline;
    }
        .plus-menu .sidebar-menu {
           position: fixed;
           top:100%;
           right: 0px;
           width: 100%;
           height: calc(60% - 124px);
           background-image: linear-gradient(
                to bottom ,
                rgb(30, 44, 122),
                rgb(147, 167, 253)
            );
           /* border: 1px solid #eee; */
           z-index: 1;
           transition: .35s; 
        }
        input[id=menuicon]:checked ~ .plus-menu .sidebar-menu{
            top:40%;
        }
        input[id=menuicon]:checked ~ .meeting-bottom .bottom-btn-box #more .menubtn #btn-more-click{
            display: inline;
        }
        input[id=menuicon]:checked ~ .meeting-bottom .bottom-btn-box #more .menubtn #btn-more{
            display: none;
        }
        .menubtn{
            margin-bottom: 0px;
        }
 

        #btn-more-click{
            display: none;
        }
        /* 버튼 */
        .btn-m{
            display:inline;
        }
        .bottom-btn-box{
            padding-top: 0;
        }
        #more, #close{
            display: inline;
        }
        .circle-btn i{
            width: 80px;
            height: 80px;
            padding: 40px;
            margin-right: 20px;
            border: 4px solid  rgb(16, 24, 133);
        }
        #more i{
            background-color:  rgb(41 58 151);
        }

        #close i{
            border: 4px solid  #af404c;
             background-color:   #af404c;
        }

        .circle-btn i:hover {
            cursor: pointer;
            /* samsung color */
            border: 4.5px solid rgb(16, 24, 133);
        }

        /* 버튼_ 삭제할버튼 */
         #invitelink, #share-screen, #share-board, #record, #conference, #clear{
            display: none;
        }
        .circle-btn:hover > p.arrow_box {
            display: none;
        }
        

        #participant-boxid.on{
            display: block;
        }

        #participant-boxid.off{
            display: none;
        }

        #chat-boxid.on{
            width: 100%;
            display: block;
        }

        #chat-boxid.off{
            display: none;
        }

        #save-boxid.on{
            width: 100%;
            padding-left: 10%;
            padding-right: 10%;
            display: block;
        }

        #savebox-header {
            margin-left: 8%;
        }
        #savebox-header-day {
            margin-right: 20%;
        }

        #uploaded-container-header{
            font-size: 2rem;
        }

        #uploaded-list{
            font-size: 1.5rem;
        }

        #save-boxid.off{
            display: none;
        }

        .wait{
            width: 100%;
        }
    }
  </style>
</html>
